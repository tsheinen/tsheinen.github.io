<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>CSAW Finals CTF 2021</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://tsheinen.github.io/main.css">
    
    

    <style>
        
        [data-theme="Dark"] {   
            --background-color: #2D283E;
            --background-alt-color: #36304B;
            --highlight-color: #DEC1FF;
            --highlight-color-alt: #ED254E;
            --foreground-color: #D1D7E0;
        }
        
        [data-theme="Light"] {   
            --background-color: #E0F5CC;
            --background-alt-color: #EAF8DD;
            --highlight-color: #D8315B;
            --highlight-color-alt: #0197F6;
            --foreground-color: #3B413C;
        }
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    
    
</head>
<body data-theme="dark">
    <script defer>

        function setTheme(theme) {
            document.body.dataset['theme'] = theme;
            localStorage.setItem('theme', theme);
        }
        window.addEventListener('storage', function(event){
            if (event.storageArea === localStorage && event.key === "theme") {
                setTheme(event.newValue);
            }
        }, false);
        setTheme(localStorage.getItem('theme') || 'dark');
        setTimeout(() => window.document.body.classList.add("transition"), 300);
    </script>
    <a class="skip-main" href="#main">Skip to content</a>
    <div class="container">
        <header> 
            <h1 class="site-header">
                <a href="https:&#x2F;&#x2F;tsheinen.github.io">Teddy Heinen</a>
            </h1>
            <nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;about&#x2F;">About</a>
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;tags&#x2F;">Tags</a>
                
<!--                 <div class="search-container">
                    <input id="search" type="search" placeholder="🧐 Search!">

                    <div class="search-results">
                        <div class="search-results__items"></div>
                    </div>
                </div> -->
                
            </nav>
        </header>
        <main id="main" tabindex="-1">
            


<nav class="toc">
  <ul>
  
      <li>
        <a href="https://tsheinen.github.io/csaw-finals-2021/#imports">Imports</a>
        <ul>
          
        </ul>
      </li>
  
      <li>
        <a href="https://tsheinen.github.io/csaw-finals-2021/#maze">Maze</a>
        <ul>
          
            <li>
                <a href="https://tsheinen.github.io/csaw-finals-2021/#lifting-it-into-a-graph">lifting it into a graph</a>
            </li>
          
            <li>
                <a href="https://tsheinen.github.io/csaw-finals-2021/#solving-for-the-hamiltonian-path">solving for the hamiltonian path</a>
            </li>
          
        </ul>
      </li>
  
      <li>
        <a href="https://tsheinen.github.io/csaw-finals-2021/#glootie">glootie</a>
        <ul>
          
        </ul>
      </li>
  
  </ul>
  <svg class="toc-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
    <path stroke="#444" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round" transform="translate(-0.5, -0.5)" />
  </svg>
</nav>

<article class="post">
    <header>
        <h1>CSAW Finals CTF 2021</h1>
    </header>

    <div class="content">
        <p>I played CSAW finals with <a href="https://ctftime.org/team/157039">idek</a>; we placed 17th overall and 5th in the US.</p>
<span id="continue-reading"></span><h1 id="imports"><a href="/csaw-finals-2021/imports">Imports</a></h1>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>Find the only Win API function called by the shellcode.
</span></code></pre>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>e839000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019622f7defaaed2b15a8be281ec0001000081e400ffffff648b0d3000000085c90f84c4010000807902000f85210000008b490c85c90f84af0100008b591485db0f84a401000083c1143bcb0f8499010000ff7328e8a500000083c40452e85100000083c4043b42310f840f0000008b1b3bcb0f8472010000e9d4ffffff8b5b100fb64a308bfa83c73103f903f903f903f98b375653e88e00000083c40889074983f9000f85dbffffffe82b010000e937010000558bec608b4d0833d233c00fbe3185f60f841b00000003f28bfec1e705c1e70503fe8bd7c1ea05d1ea33d741e9daffffff8d04d28bc8c1e90b33c88bc1c1e00f03c18944241c618be55dc3558bec608b750833c9668b066685c00f840d0000000c20880283c60242e9e7ffffffc60200618be55dc3558bec6083ec188b7d0885ff0f84910000008b550c8b4f3c8b44397885c00f847f000000837c397c000f84740000008d0c38890c248b4c381c03cf894c24048b4c382003cf894c24088b4c382403cf894c240c8b0424837818000f844300000033db8b4424088b0c98803c39000f842a0000008d043950e80fffffff83c4043bc20f85160000008b44240c0fb70c588b4424048b048803c7e90800000043e9bfffffff33c083c4188944241c618be55dc3558bec6052ff52358944241c618be55dc39090909090909090
</span></code></pre>
<p>God, fuck, windows :(</p>
<p>I wasn't gonna do this but then I found a lovely paragraph on the <a href="https://docs.qiling.io/en/latest/">Qiling</a> documentation.</p>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>Not only working cross-architecture, Qiling is also cross-platform, so for example you can run Linux ELF file on top of Windows. In contrast, Qemu usermode only run binary of the same OS, such as Linux ELF on Linux, due to the way it forwards syscall from emulated code to native OS
</span></code></pre>
<p>Fuck yeah I'm never gonna use windows again.</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">import </span><span>sys
</span><span style="color:#ffa759;">from </span><span>qiling </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">from </span><span>unicorn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">from </span><span>unicorn</span><span style="color:#f29e74;">.</span><span>x86_const </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">from </span><span>qiling</span><span style="color:#f29e74;">.</span><span>os</span><span style="color:#f29e74;">.</span><span>posix</span><span style="color:#f29e74;">.</span><span>stat </span><span style="color:#ffa759;">import </span><span>Fstat
</span><span style="color:#ffa759;">import </span><span>capstone</span><span style="color:#f29e74;">.</span><span>x86_const
</span><span style="color:#ffa759;">from </span><span>binascii </span><span style="color:#ffa759;">import </span><span>hexlify
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">code_hook</span><span>(</span><span style="color:#ffcc66;">ql</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">address</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">size</span><span>):
</span><span>    </span><span style="color:#ffa759;">global </span><span>dump
</span><span>    buf </span><span style="color:#f29e74;">= </span><span>ql</span><span style="color:#f29e74;">.</span><span>mem</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>(address</span><span style="color:#ccc9c2cc;">, </span><span>size)
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span>md</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">disasm</span><span>(buf</span><span style="color:#ccc9c2cc;">, </span><span>address):
</span><span>        </span><span style="color:#ffa759;">if </span><span>i</span><span style="color:#f29e74;">.</span><span>mnemonic </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;call&quot; </span><span style="color:#f29e74;">and </span><span>i</span><span style="color:#f29e74;">.</span><span>op_str </span><span style="color:#f29e74;">!= </span><span style="color:#bae67e;">&quot;0x400e9&quot; </span><span>:
</span><span>        	</span><span style="color:#f28779;">print</span><span>(</span><span style="color:#bae67e;">&quot;[*] 0x</span><span style="color:#ffcc66;">{:08x}</span><span style="color:#bae67e;">: </span><span style="color:#ffcc66;">{} {}</span><span style="color:#bae67e;">&quot;</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">format</span><span>(i</span><span style="color:#f29e74;">.</span><span>address</span><span style="color:#ccc9c2cc;">, </span><span>i</span><span style="color:#f29e74;">.</span><span>mnemonic</span><span style="color:#ccc9c2cc;">, </span><span>i</span><span style="color:#f29e74;">.</span><span>op_str))
</span><span>        </span><span style="color:#ffa759;">if </span><span>address </span><span style="color:#f29e74;">==</span><span style="color:#ffcc66;">0x0004004d</span><span>:
</span><span>        	ql</span><span style="color:#f29e74;">.</span><span>reg</span><span style="color:#f29e74;">.</span><span>esp </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0xfffe0000
</span><span>code </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">bytes</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">fromhex</span><span>(</span><span style="color:#bae67e;">&quot;e839000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019622f7defaaed2b15a8be281ec0001000081e400ffffff648b0d3000000085c90f84c4010000807902000f85210000008b490c85c90f84af0100008b591485db0f84a401000083c1143bcb0f8499010000ff7328e8a500000083c40452e85100000083c4043b42310f840f0000008b1b3bcb0f8472010000e9d4ffffff8b5b100fb64a308bfa83c73103f903f903f903f98b375653e88e00000083c40889074983f9000f85dbffffffe82b010000e937010000558bec608b4d0833d233c00fbe3185f60f841b00000003f28bfec1e705c1e70503fe8bd7c1ea05d1ea33d741e9daffffff8d04d28bc8c1e90b33c88bc1c1e00f03c18944241c618be55dc3558bec608b750833c9668b066685c00f840d0000000c20880283c60242e9e7ffffffc60200618be55dc3558bec6083ec188b7d0885ff0f84910000008b550c8b4f3c8b44397885c00f847f000000837c397c000f84740000008d0c38890c248b4c381c03cf894c24048b4c382003cf894c24088b4c382403cf894c240c8b0424837818000f844300000033db8b4424088b0c98803c39000f842a0000008d043950e80fffffff83c4043bc20f85160000008b44240c0fb70c588b4424048b048803c7e90800000043e9bfffffff33c083c4188944241c618be55dc3558bec6052ff52358944241c618be55dc39090909090909090&quot;</span><span>)
</span><span>ql </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">Qiling</span><span>(</span><span style="color:#ffcc66;">shellcoder</span><span style="color:#f29e74;">=</span><span>code</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">ostype</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&quot;windows&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">rootfs</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&quot;/home/sky/tools/qiling/examples/rootfs/x86_windows&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">archtype</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&quot;x86&quot;</span><span>)
</span><span>ql</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">hook_code</span><span>(code_hook)
</span><span>md </span><span style="color:#f29e74;">= </span><span>ql</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">create_disassembler</span><span>()
</span><span>md</span><span style="color:#f29e74;">.</span><span>detail </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">True
</span><span>ql</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">run</span><span>()
</span></code></pre>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>❯ python solve.py
</span><span>[=]	Initiate stack address at 0xfffdd000 
</span><span>[=]	TEB addr is 0x6000
</span><span>[=]	PEB addr is 0x6044
</span><span>[=]	Loading /home/sky/tools/qiling/examples/rootfs/x86_windows/Windows/System32/ntdll.dll ...
</span><span>[!]	Warnings while loading /home/sky/tools/qiling/examples/rootfs/x86_windows/Windows/System32/ntdll.dll:
</span><span>[!]	- SizeOfHeaders is smaller than AddressOfEntryPoint: this file cannot run under Windows 8.
</span><span>[!]	- AddressOfEntryPoint lies outside the sections&#39; boundaries. AddressOfEntryPoint: 0x0
</span><span>[=]	Done with loading /home/sky/tools/qiling/examples/rootfs/x86_windows/Windows/System32/ntdll.dll
</span><span>[=]	Loading /home/sky/tools/qiling/examples/rootfs/x86_windows/Windows/System32/kernel32.dll ...
</span><span>[=]	Done with loading /home/sky/tools/qiling/examples/rootfs/x86_windows/Windows/System32/kernel32.dll
</span><span>[=]	Loading /home/sky/tools/qiling/examples/rootfs/x86_windows/Windows/System32/user32.dll ...
</span><span>[=]	Done with loading /home/sky/tools/qiling/examples/rootfs/x86_windows/Windows/System32/user32.dll
</span><span>56
</span><span>[*] 0x00040000: call 0x4003e
</span><span>[*] 0x0004008a: call 0x40134
</span><span>[*] 0x0004008a: call 0x40134
</span><span>[*] 0x0004008a: call 0x40134
</span><span>[*] 0x000400cb: call 0x4015e
</span><span>[*] 0x000400df: call 0x4020f
</span><span>[*] 0x00040214: call dword ptr [edx + 0x35]
</span><span>[!]	api GetKeyboardLayoutNameA is not implemented
</span><span>[*] 0x69e88825: call dword ptr [0x69ea37b4]
</span></code></pre>
<p>Haha sweet I didn't need to do anything because Qiling kindly told me that they didn't implement the function which got called. I was confused for a little bit but then we got an announcement clarifying the flag format; take the function and wrap it in flag{}</p>
<p>flag: flag{GetKeyboardLayoutNameA}</p>
<h1 id="maze"><a href="/csaw-finals-2021/maze">Maze</a></h1>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>Feel free to take a tour, but good luck finding your way out of this one!
</span></code></pre>
<p><a href="/csaw-finals-2021/maze_public">maze_public</a></p>
<p>To start with we have a stripped binary and a server running that binary; we get the flag if we make it validate.</p>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>❯ ./maze_public
</span><span>Please type your input: 
</span><span>hi
</span><span>Try again!
</span></code></pre>
<p>Looks like we're trying to find the input which makes it not say "Try again!"? Let's open it up and see how it makes that decision!</p>
<p><img src="/csaw-finals-2021/maze_start_disas.png" alt="disassembled _start function" /></p>
<p>Ah syscalls, lovely -- we read in some input and pass it to <code>sub_403eb6</code>. If the return value is 64 we get the flag.</p>
<p><img src="/csaw-finals-2021/maze_first_graph_function.png" alt="disassembled sub_403eb6" /></p>
<p>This is real gnarly. You can't see the bottom of the function in that picture but here is a summary.</p>
<ol>
<li>Set the first byte to 0xc3 (ret in x86)</li>
<li>You can't see it in the decompilation but it increments the register r15 (this is used as a return value when the function returns)</li>
<li>Retrieve the first byte of the input and increment the pointer (so the next function will get the next byte)</li>
<li>Set rbx and rcx based on the byte (only accepts 1-8)</li>
<li>Jumps to one of 8 successor functions based on rbx and rcx; some of these successor functions will immediately return</li>
</ol>
<p>So immediately we're looking to do a graph traversal of this to find a path of 64 functions. My first attempt involved patching the binary to write r15 to stdout and then writing a naive depth first traversal based on inputs which increase the depth. Unfortunately this turned out to be super not tractable; I came back an hour later to 57-58 length paths and it had spent most of the hour around that same length.</p>
<p>As it turns out there are only 64 unique nodes which makes this problem significantly harder. We're looking to find a <a href="https://en.wikipedia.org/wiki/Hamiltonian_path">hamiltonian path</a> which for a directed cyclic graph (this unfortunately has many cycles) is NP-complete and a naive solution will finish approximately fucking never. Fortunately there are heuristic solutions which can be applied to solve it in a reasonable amount of time.</p>
<h2 id="lifting-it-into-a-graph">lifting it into a graph</h2>
<p>This ended up actually being really straightforward! The "directions" aka values of rbx &amp; rcx are constant which means we have two values to extract for each function -- the address of the function and the address it uses as a base to compute successor functions.</p>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>405ebe:	48 8d 05 f9 ff ff ff 	lea    rax,[rip+0xfffffffffffffff9]        # 0x405ebe
</span><span>405ec5:	c6 00 c3             	mov    BYTE PTR [rax],0xc3
</span><span>405ec8:	49 ff c7             	inc    r15
</span><span>405ecb:	8a 07                	mov    al,BYTE PTR [rdi]
</span><span>405ecd:	48 ff c7             	inc    rdi
</span><span>405ed0:	3c 0a                	cmp    al,0xa
</span><span>405ed2:	0f 84 b2 00 00 00    	je     0x405f8a
</span><span>405ed8:	2c 30                	sub    al,0x30
</span><span>405eda:	3c 01                	cmp    al,0x1
</span><span>405edc:	75 0e                	jne    0x405eec
</span><span>405ede:	48 c7 c3 fe ff ff ff 	mov    rbx,0xfffffffffffffffe
</span><span>405ee5:	b9 01 00 00 00       	mov    ecx,0x1
</span><span>405eea:	eb 7e                	jmp    0x405f6a
</span><span>405eec:	3c 02                	cmp    al,0x2
</span><span>405eee:	75 0e                	jne    0x405efe
</span><span>405ef0:	48 c7 c3 ff ff ff ff 	mov    rbx,0xffffffffffffffff
</span><span>405ef7:	b9 02 00 00 00       	mov    ecx,0x2
</span><span>405efc:	eb 6c                	jmp    0x405f6a
</span><span>405efe:	3c 03                	cmp    al,0x3
</span><span>405f00:	75 0c                	jne    0x405f0e
</span><span>405f02:	bb 01 00 00 00       	mov    ebx,0x1
</span><span>405f07:	b9 02 00 00 00       	mov    ecx,0x2
</span><span>405f0c:	eb 5c                	jmp    0x405f6a
</span><span>405f0e:	3c 04                	cmp    al,0x4
</span><span>405f10:	75 0c                	jne    0x405f1e
</span><span>405f12:	bb 02 00 00 00       	mov    ebx,0x2
</span><span>405f17:	b9 01 00 00 00       	mov    ecx,0x1
</span><span>405f1c:	eb 4c                	jmp    0x405f6a
</span><span>405f1e:	3c 05                	cmp    al,0x5
</span><span>405f20:	75 0e                	jne    0x405f30
</span><span>405f22:	bb 02 00 00 00       	mov    ebx,0x2
</span><span>405f27:	48 c7 c1 ff ff ff ff 	mov    rcx,0xffffffffffffffff
</span><span>405f2e:	eb 3a                	jmp    0x405f6a
</span><span>405f30:	3c 06                	cmp    al,0x6
</span><span>405f32:	75 0e                	jne    0x405f42
</span><span>405f34:	bb 01 00 00 00       	mov    ebx,0x1
</span><span>405f39:	48 c7 c1 fe ff ff ff 	mov    rcx,0xfffffffffffffffe
</span><span>405f40:	eb 28                	jmp    0x405f6a
</span><span>405f42:	3c 07                	cmp    al,0x7
</span><span>405f44:	75 10                	jne    0x405f56
</span><span>405f46:	48 c7 c3 ff ff ff ff 	mov    rbx,0xffffffffffffffff
</span><span>405f4d:	48 c7 c1 fe ff ff ff 	mov    rcx,0xfffffffffffffffe
</span><span>405f54:	eb 14                	jmp    0x405f6a
</span><span>405f56:	3c 08                	cmp    al,0x8
</span><span>405f58:	75 30                	jne    0x405f8a
</span><span>405f5a:	48 c7 c3 fe ff ff ff 	mov    rbx,0xfffffffffffffffe
</span><span>405f61:	48 c7 c1 ff ff ff ff 	mov    rcx,0xffffffffffffffff
</span><span>405f68:	eb 00                	jmp    0x405f6a
</span><span>405f6a:	48 6b db 0c          	imul   rbx,rbx,0xc
</span><span>405f6e:	48 01 cb             	add    rbx,rcx
</span><span>405f71:	48 69 db cd 00 00 00 	imul   rbx,rbx,0xcd
</span><span>405f78:	48 8d 05 f9 ff ff ff 	lea    rax,[rip+0xfffffffffffffff9]        # 0x405f78
</span><span>405f7f:	48 2d ba 00 00 00    	sub    rax,0xba
</span><span>405f85:	48 01 d8             	add    rax,rbx
</span><span>405f88:	ff e0                	jmp    rax
</span><span>405f8a:	c3                   	ret    
</span></code></pre>
<p>Fortunately, objdump is kinda enough to highlight these addresses (and only these addresses!).  So it's pretty straightforward to clean this up a bit.</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">objdump</span><span style="color:#ffcc66;"> -D -Mintel</span><span> ./maze_public </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">rg</span><span style="color:#ffcc66;"> -v</span><span> nop </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">tail</span><span style="color:#ffcc66;"> -n</span><span> +67 </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">head</span><span style="color:#ffcc66;"> -n -77 </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">rg </span><span style="color:#bae67e;">&quot;# &quot; </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">rg </span><span style="color:#bae67e;">&quot;.*?# (.*)&quot;</span><span style="color:#ffcc66;"> -r </span><span style="color:#bae67e;">&#39;$1&#39;
</span></code></pre>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>0x4015df
</span><span>0x401699
</span><span>0x4016ac
</span><span>0x401766
</span><span>0x401779
</span><span>...
</span></code></pre>
<p>Each pair of addresses represent (node, base successor address) and everything else is static so can be computed.</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">import </span><span>networkx </span><span style="color:#ffa759;">as </span><span>nx
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">chunks</span><span>(</span><span style="color:#ffcc66;">lst</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">n</span><span>):
</span><span>    </span><span style="font-style:italic;color:#5c6773;">&quot;&quot;&quot;Yield successive n-sized chunks from lst.&quot;&quot;&quot;
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">len</span><span>(lst)</span><span style="color:#ccc9c2cc;">, </span><span>n):
</span><span>        </span><span style="color:#ffa759;">yield </span><span>lst[i</span><span style="color:#ccc9c2cc;">:</span><span>i </span><span style="color:#f29e74;">+ </span><span>n]
</span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;functions.txt&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#bae67e;">&quot;r&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>	lines </span><span style="color:#f29e74;">= </span><span>[x</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">rstrip</span><span>() </span><span style="color:#ffa759;">for </span><span>x </span><span style="color:#ffa759;">in </span><span>f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">readlines</span><span>()]
</span><span>G </span><span style="color:#f29e74;">= </span><span>nx</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">DiGraph</span><span>()
</span><span>labels </span><span style="color:#f29e74;">= </span><span>{}
</span><span style="color:#ffa759;">for </span><span>a</span><span style="color:#ccc9c2cc;">,</span><span>b </span><span style="color:#ffa759;">in </span><span style="color:#ffd580;">chunks</span><span>(lines</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span>):
</span><span>	G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_node</span><span>(a)
</span><span style="color:#ffa759;">for </span><span>a</span><span style="color:#ccc9c2cc;">,</span><span>b </span><span style="color:#ffa759;">in </span><span style="color:#ffd580;">chunks</span><span>(lines</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span>):
</span><span>	</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">compute</span><span>(</span><span style="color:#ffcc66;">base</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">rbx</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">rcx</span><span>):
</span><span>		</span><span style="color:#ffa759;">return </span><span>(rcx </span><span style="color:#f29e74;">+ </span><span>rbx </span><span style="color:#f29e74;">* </span><span style="color:#ffcc66;">0xc</span><span>)</span><span style="color:#f29e74;">*</span><span style="color:#ffcc66;">0xcd  </span><span style="color:#f29e74;">+ </span><span>(</span><span style="font-style:italic;color:#5ccfe6;">int</span><span>(base</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">16</span><span>) </span><span style="color:#f29e74;">- </span><span style="color:#ffcc66;">0xba</span><span>)
</span><span>	</span><span style="color:#ffa759;">for </span><span>tag</span><span style="color:#ccc9c2cc;">, </span><span>rbx</span><span style="color:#ccc9c2cc;">, </span><span>rcx </span><span style="color:#ffa759;">in </span><span>[(</span><span style="color:#bae67e;">&quot;1&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;2&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;3&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;4&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;5&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;6&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;7&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;8&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">,</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span>)]:
</span><span>		next_node </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">hex</span><span>(</span><span style="color:#ffd580;">compute</span><span>(b</span><span style="color:#ccc9c2cc;">, </span><span>rbx</span><span style="color:#ccc9c2cc;">, </span><span>rcx))
</span><span>		labels[(a</span><span style="color:#ccc9c2cc;">,</span><span>next_node)] </span><span style="color:#f29e74;">= </span><span>tag
</span><span>		G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_edge</span><span>(a</span><span style="color:#ccc9c2cc;">,</span><span>next_node)
</span><span style="font-style:italic;color:#5c6773;">## construct adjacency list and prune terminal nodes
</span><span>adj </span><span style="color:#f29e74;">= </span><span>{k</span><span style="color:#ccc9c2cc;">: </span><span>[x </span><span style="color:#ffa759;">for </span><span>x </span><span style="color:#ffa759;">in </span><span>G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">neighbors</span><span>(k) </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(</span><span style="font-style:italic;color:#5ccfe6;">list</span><span>(G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">neighbors</span><span>(x))) </span><span style="color:#f29e74;">&gt; </span><span style="color:#ffcc66;">0</span><span>] </span><span style="color:#ffa759;">for </span><span>k </span><span style="color:#ffa759;">in </span><span>G</span><span style="color:#f29e74;">.</span><span>nodes}
</span><span>adj </span><span style="color:#f29e74;">= </span><span>{k</span><span style="color:#ccc9c2cc;">: </span><span>v </span><span style="color:#ffa759;">for </span><span>k</span><span style="color:#ccc9c2cc;">, </span><span>v </span><span style="color:#ffa759;">in </span><span>adj</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">items</span><span>() </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(v) </span><span style="color:#f29e74;">&gt; </span><span style="color:#ffcc66;">0</span><span>}
</span><span>mapping </span><span style="color:#f29e74;">= </span><span>{</span><span style="color:#bae67e;">&quot;0x403eb6&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffcc66;">0</span><span>} </span><span style="font-style:italic;color:#5c6773;"># this is our start node so instead of modifying the cpp im just gonna make 0 the first node
</span><span>count </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">1
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span>adj</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">keys</span><span>():
</span><span>	</span><span style="color:#ffa759;">if </span><span>i </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;0x403eb6&quot;</span><span>:
</span><span>		</span><span style="color:#ffa759;">continue
</span><span>	mapping[i] </span><span style="color:#f29e74;">= </span><span>count
</span><span>	count </span><span style="color:#f29e74;">+= </span><span style="color:#ffcc66;">1
</span><span style="color:#f28779;">print</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;</span><span>{</span><span style="color:#f28779;">len</span><span>(adj</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">keys</span><span>())} {</span><span style="color:#f28779;">sum</span><span>([</span><span style="color:#f28779;">len</span><span>(x) </span><span style="color:#ffa759;">for </span><span>x </span><span style="color:#ffa759;">in </span><span>adj</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">values</span><span>()])}</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span style="color:#ffa759;">for </span><span>k</span><span style="color:#ccc9c2cc;">,</span><span>v </span><span style="color:#ffa759;">in </span><span>adj</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">items</span><span>():
</span><span>	</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span>v:
</span><span>		</span><span style="color:#f28779;">print</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;</span><span>{mapping[k]} {mapping[i]}</span><span style="color:#bae67e;">&quot;</span><span>)
</span></code></pre>
<h2 id="solving-for-the-hamiltonian-path">solving for the hamiltonian path</h2>
<p>Now begins the long long search for a heuristic solution which does not segfault and will solve the problem in a reasonable time!</p>
<p>I ended up using a github repository <a href="https://github.com/mraggi/LongestSimplePath">mraggi/LongestSimplePath</a> with some minor modifications to only find paths starting with node 0 and to take a graph from stdin.</p>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>❯ python make_graph.py | ~/Downloads/LongestSimplePath/lsp
</span><span>Created graph!
</span><span>Digraph on 64 vertices: [ 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 ]
</span><span>Finished preprocessing in: 0.093459
</span><span>Doing DFS search...
</span><span>Found DFS improvement at 8.5e-05 to 63
</span><span>Done DFS search! Best Value = 63
</span><span>Time taken for dfs: 0.900292
</span><span>Doing PTO improving search...
</span><span>The best path I found for graph G with the default options has value 63
</span><span>0 50 56 41 58 48 34 17 2 12 6 16 31 47 62 52 46 63 53 59 49 33 18 1 11 5 15 32 22 7 24 14 8 23 39 54 60 45 55 61 51 57 40 26 9 3 13 19 4 10 25 35 20 30 44 38 29 43 27 21 37 28 42 36
</span></code></pre>
<p>Woohoo!  A path!  At this point all that is left is to translate it back into ascii numbers</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">import </span><span>networkx </span><span style="color:#ffa759;">as </span><span>nx
</span><span style="color:#ffa759;">from </span><span>collections </span><span style="color:#ffa759;">import </span><span>deque
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">window</span><span>(</span><span style="color:#ffcc66;">seq</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">n</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">2</span><span>):
</span><span>    it </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">iter</span><span>(seq)
</span><span>    win </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">deque</span><span>((</span><span style="color:#f28779;">next</span><span>(it</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">None</span><span>) </span><span style="color:#ffa759;">for </span><span style="font-style:italic;color:#5ccfe6;">_ </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(n))</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">maxlen</span><span style="color:#f29e74;">=</span><span>n)
</span><span>    </span><span style="color:#ffa759;">yield </span><span>win
</span><span>    append </span><span style="color:#f29e74;">= </span><span>win</span><span style="color:#f29e74;">.</span><span>append
</span><span>    </span><span style="color:#ffa759;">for </span><span>e </span><span style="color:#ffa759;">in </span><span>it:
</span><span>        </span><span style="color:#ffd580;">append</span><span>(e)
</span><span>        </span><span style="color:#ffa759;">yield </span><span>win
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">chunks</span><span>(</span><span style="color:#ffcc66;">lst</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">n</span><span>):
</span><span>    </span><span style="font-style:italic;color:#5c6773;">&quot;&quot;&quot;Yield successive n-sized chunks from lst.&quot;&quot;&quot;
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">len</span><span>(lst)</span><span style="color:#ccc9c2cc;">, </span><span>n):
</span><span>        </span><span style="color:#ffa759;">yield </span><span>lst[i</span><span style="color:#ccc9c2cc;">:</span><span>i </span><span style="color:#f29e74;">+ </span><span>n]
</span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;functions.txt&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#bae67e;">&quot;r&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>	lines </span><span style="color:#f29e74;">= </span><span>[x</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">rstrip</span><span>() </span><span style="color:#ffa759;">for </span><span>x </span><span style="color:#ffa759;">in </span><span>f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">readlines</span><span>()]
</span><span>G </span><span style="color:#f29e74;">= </span><span>nx</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">DiGraph</span><span>()
</span><span>labels </span><span style="color:#f29e74;">= </span><span>{}
</span><span style="color:#ffa759;">for </span><span>a</span><span style="color:#ccc9c2cc;">,</span><span>b </span><span style="color:#ffa759;">in </span><span style="color:#ffd580;">chunks</span><span>(lines</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span>):
</span><span>	G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_node</span><span>(a)
</span><span>    
</span><span style="color:#ffa759;">for </span><span>a</span><span style="color:#ccc9c2cc;">,</span><span>b </span><span style="color:#ffa759;">in </span><span style="color:#ffd580;">chunks</span><span>(lines</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span>):
</span><span>	</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">compute</span><span>(</span><span style="color:#ffcc66;">base</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">rbx</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">rcx</span><span>):
</span><span>		</span><span style="color:#ffa759;">return </span><span>(rcx </span><span style="color:#f29e74;">+ </span><span>rbx </span><span style="color:#f29e74;">* </span><span style="color:#ffcc66;">0xc</span><span>)</span><span style="color:#f29e74;">*</span><span style="color:#ffcc66;">0xcd  </span><span style="color:#f29e74;">+ </span><span>(</span><span style="font-style:italic;color:#5ccfe6;">int</span><span>(base</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">16</span><span>) </span><span style="color:#f29e74;">- </span><span style="color:#ffcc66;">0xba</span><span>)
</span><span>	</span><span style="color:#ffa759;">for </span><span>tag</span><span style="color:#ccc9c2cc;">, </span><span>rbx</span><span style="color:#ccc9c2cc;">, </span><span>rcx </span><span style="color:#ffa759;">in </span><span>[(</span><span style="color:#bae67e;">&quot;1&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;2&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;3&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;4&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;5&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;6&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;7&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">, </span><span>(</span><span style="color:#bae67e;">&quot;8&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2cc;">,</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1</span><span>)]:
</span><span>		next_node </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">hex</span><span>(</span><span style="color:#ffd580;">compute</span><span>(b</span><span style="color:#ccc9c2cc;">, </span><span>rbx</span><span style="color:#ccc9c2cc;">, </span><span>rcx))
</span><span>		labels[(a</span><span style="color:#ccc9c2cc;">,</span><span>next_node)] </span><span style="color:#f29e74;">= </span><span>tag
</span><span>		G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_edge</span><span>(a</span><span style="color:#ccc9c2cc;">,</span><span>next_node)
</span><span>adj </span><span style="color:#f29e74;">= </span><span>{k</span><span style="color:#ccc9c2cc;">: </span><span>[x </span><span style="color:#ffa759;">for </span><span>x </span><span style="color:#ffa759;">in </span><span>G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">neighbors</span><span>(k) </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(</span><span style="font-style:italic;color:#5ccfe6;">list</span><span>(G</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">neighbors</span><span>(x))) </span><span style="color:#f29e74;">&gt; </span><span style="color:#ffcc66;">0</span><span>] </span><span style="color:#ffa759;">for </span><span>k </span><span style="color:#ffa759;">in </span><span>G</span><span style="color:#f29e74;">.</span><span>nodes}
</span><span>adj </span><span style="color:#f29e74;">= </span><span>{k</span><span style="color:#ccc9c2cc;">: </span><span>v </span><span style="color:#ffa759;">for </span><span>k</span><span style="color:#ccc9c2cc;">, </span><span>v </span><span style="color:#ffa759;">in </span><span>adj</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">items</span><span>() </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(v) </span><span style="color:#f29e74;">&gt; </span><span style="color:#ffcc66;">0</span><span>}
</span><span>mapping </span><span style="color:#f29e74;">= </span><span>{</span><span style="color:#bae67e;">&quot;0x403eb6&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffcc66;">0</span><span>}
</span><span>count </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">1
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span>adj</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">keys</span><span>():
</span><span>	</span><span style="color:#ffa759;">if </span><span>i </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;0x403eb6&quot;</span><span>:
</span><span>		</span><span style="color:#ffa759;">continue
</span><span>	mapping[i] </span><span style="color:#f29e74;">= </span><span>count
</span><span>	count </span><span style="color:#f29e74;">+= </span><span style="color:#ffcc66;">1
</span><span>reverse_mapping </span><span style="color:#f29e74;">= </span><span>{v</span><span style="color:#ccc9c2cc;">:</span><span>k </span><span style="color:#ffa759;">for </span><span>k</span><span style="color:#ccc9c2cc;">,</span><span>v </span><span style="color:#ffa759;">in </span><span>mapping</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">items</span><span>()}
</span><span>cycle </span><span style="color:#f29e74;">= </span><span>[</span><span style="font-style:italic;color:#5ccfe6;">int</span><span>(x) </span><span style="color:#ffa759;">for </span><span>x </span><span style="color:#ffa759;">in </span><span style="color:#bae67e;">&quot;0 50 56 41 58 48 34 17 2 12 6 16 31 47 62 52 46 63 53 59 49 33 18 1 11 5 15 32 22 7 24 14 8 23 39 54 60 45 55 61 51 57 40 26 9 3 13 19 4 10 25 35 20 30 44 38 29 43 27 21 37 28 42 36&quot;</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">split</span><span>(</span><span style="color:#bae67e;">&quot; &quot;</span><span>)]
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#ffd580;">window</span><span>(cycle):
</span><span>	</span><span style="color:#f28779;">print</span><span>(labels[(reverse_mapping[i[</span><span style="color:#ffcc66;">0</span><span>]]</span><span style="color:#ccc9c2cc;">,</span><span>reverse_mapping[i[</span><span style="color:#ffcc66;">1</span><span>]])]</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">end</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&quot;&quot;</span><span>)
</span></code></pre>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>❯ python path_to_input.py
</span><span>561471813235457247678183234714725456136768182361653135275824752%                                                                                                                                                                                ❯ ./maze_public
</span><span>Please type your input: 
</span><span>561471813235457247678183234714725456136768182361653135275824752
</span><span>Well done! Please validate the input on the remote server
</span></code></pre>
<p>And that's it!</p>
<p>flag: flag{Kn1ght_t0ur_0n_chess_b0ard}</p>
<h1 id="glootie"><a href="/csaw-finals-2021/glootie">glootie</a></h1>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>glootie has made an app which is super-safe! no one in the J19-Zeta-7 universe can crack the password!
</span></code></pre>
<p><a href="/csaw-finals-2021/app-debug.apk">app-debug.apk</a></p>
<p>Hmm Android reversing; gonna use the lovely <a href="https://github.com/skylot/jadx">jadx-gui</a></p>
<p><img src="/csaw-finals-2021/glootie_native_func.png" alt="checkPassword is native fuck" /></p>
<p>Well ok I'll grab the native libs and reverse that.</p>
<p><img src="/csaw-finals-2021/glootie_assets_shaders.png" alt="shaders in assets" /></p>
<p>Oops, fear. Well, let's look at the checkPassword function anyway.</p>
<p><img src="/csaw-finals-2021/glootie_checkPasswd_decomp.png" alt="" /></p>
<p>So looks like we load the shader, send it the password, and then assert that the return value is [0, 1, 2, 3, 4,...]. Looks like we aren't getting out of reversing the shader.</p>
<p>I found a tool called <a href="https://github.com/KhronosGroup/SPIRV-Cross">spirv-cross</a> and used it to decompile the shaders.</p>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>❯ ~/tools/spirv-cross/bin/spirv-cross --version 310 --es assets/shaders/test.comp.spv
</span><span>##version 310 es
</span><span>layout(local_size_x = 1, local_size_y = 1, local_size_z = 1) in;
</span><span>const uint _39[34] = uint[](102u, 109u, 99u, 100u, 127u, 100u, 106u, 80u, 57u, 112u, 112u, 84u, 121u, 62u, 107u, 80u, 116u, 32u, 124u, 84u, 120u, 112u, 84u, 39u, 104u, 70u, 46u, 68u, 122u, 113u, 45u, 44u, 98u, 92u);
</span><span>layout(binding = 0, std430) buffer MyBuffer
</span><span>{
</span><span>    uint array[];
</span><span>} myBuffer;
</span><span>struct Scalar
</span><span>{
</span><span>    uint x;
</span><span>};
</span><span>uniform Scalar scalar;
</span><span>void main()
</span><span>{
</span><span>    uint i = gl_GlobalInvocationID.x;
</span><span>    myBuffer.array[i] = _39[i] ^ myBuffer.array[i];
</span><span>}
</span></code></pre>
<p>It'll XOR each byte of the input with a byte in an array. Since we know the expected output we can just solve for the flag!</p>
<p>flag: flag{alW1yz_u3e_d1nGleB0p_4_fl33B}</p>

    </div>

    
    <div class="article-info">
        
        <div class="article-date">14 November 2021</div>
        
        <div class="article-taxonomies">
            
            
                <ul class="article-tags">
                    
                    <li><a href="https://tsheinen.github.io/tags/ctf-writeups/">#ctf-writeups</a></li>
                    
                </ul>
            
        </div>
    </div>

</article>

<script>
window.onscroll = function() {
    if (window.innerHeight + window.pageYOffset >= document.body.offsetHeight) {
        var count = 200;
        var defaults = {
          origin: { y: 0.7 }
        };

        function fire(particleRatio, opts) {
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
          }));
        }

        fire(0.25, {
          spread: 26,
          startVelocity: 55,
        });
        fire(0.2, {
          spread: 60,
        });
        fire(0.35, {
          spread: 100,
          decay: 0.91,
          scalar: 0.8
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 25,
          decay: 0.92,
          scalar: 1.2
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 45,
        });
    }
}
</script>
<script type="text/javascript" src="/js/navbar.js"></script>


        </main>
        <footer>
            
            
        </footer>
    </div>



    <details data-popover="up" style="right: 20px;top: 20px;">
      <summary>
		  <svg class="paint-roller" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="paint-roller" class="svg-inline--fa fa-paint-roller fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M416 128V32c0-17.67-14.33-32-32-32H32C14.33 0 0 14.33 0 32v96c0 17.67 14.33 32 32 32h352c17.67 0 32-14.33 32-32zm32-64v128c0 17.67-14.33 32-32 32H256c-35.35 0-64 28.65-64 64v32c-17.67 0-32 14.33-32 32v128c0 17.67 14.33 32 32 32h64c17.67 0 32-14.33 32-32V352c0-17.67-14.33-32-32-32v-32h160c53.02 0 96-42.98 96-96v-64c0-35.35-28.65-64-64-64z"/></svg>
      </summary>
      <div class="swatch-container">
          
            <div class="swatch-child" onclick="setTheme('Dark')">
                <div style="text-align: center;">
                  <div data-theme=Dark class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Dark </span>
              </div>
            </div>
          
            <div class="swatch-child" onclick="setTheme('Light')">
                <div style="text-align: center;">
                  <div data-theme=Light class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Light </span>
              </div>
            </div>
          
      </div>
    </details>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "1e533cda4e344b0bb7c6bf7aef70a519"}'></script>
    <!-- End Cloudflare Web Analytics -->

    <script type="text/javascript" src="https://tsheinen.github.io/elasticlunr.min.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/search_index.en.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/js/search.js"></script>
</body>
</html>
