<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>Vault</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://tsheinen.github.io/main.css">
    
    

    <style>
        
        [data-theme="Dark"] {   
            --background-color: #2D283E;
            --background-alt-color: #36304B;
            --highlight-color: #DEC1FF;
            --highlight-color-alt: #ED254E;
            --foreground-color: #D1D7E0;
        }
        
        [data-theme="Light"] {   
            --background-color: #E0F5CC;
            --background-alt-color: #EAF8DD;
            --highlight-color: #D8315B;
            --highlight-color-alt: #0197F6;
            --foreground-color: #3B413C;
        }
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    
    
</head>
<body data-theme="dark">
    <script defer>

        function setTheme(theme) {
            document.body.dataset['theme'] = theme;
            localStorage.setItem('theme', theme);
        }
        window.addEventListener('storage', function(event){
            if (event.storageArea === localStorage && event.key === "theme") {
                setTheme(event.newValue);
            }
        }, false);
        setTheme(localStorage.getItem('theme') || 'dark');
        setTimeout(() => window.document.body.classList.add("transition"), 300);
    </script>
    <a class="skip-main" href="#main">Skip to content</a>
    <div class="container">
        <header> 
            <h1 class="site-header">
                <a href="https:&#x2F;&#x2F;tsheinen.github.io">Teddy Heinen</a>
            </h1>
            <nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;about&#x2F;">About</a>
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;tags&#x2F;">Tags</a>
                
<!--                 <div class="search-container">
                    <input id="search" type="search" placeholder="üßê Search!">

                    <div class="search-results">
                        <div class="search-results__items"></div>
                    </div>
                </div> -->
                
            </nav>
        </header>
        <main id="main" tabindex="-1">
            


<nav class="toc">
  <ul>
  
      <li>
        <a href="https://tsheinen.github.io/htb-uni-quals-2021/vault/#reversing">reversing</a>
        <ul>
          
        </ul>
      </li>
  
      <li>
        <a href="https://tsheinen.github.io/htb-uni-quals-2021/vault/#solve">solve</a>
        <ul>
          
        </ul>
      </li>
  
  </ul>
  <svg class="toc-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
    <path stroke="#444" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round" transform="translate(-0.5, -0.5)" />
  </svg>
</nav>

<article class="post">
    <header>
        <h1>Vault</h1>
    </header>

    <div class="content">
        <pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>After following a series of tips, you have arrived at your destination; a giant vault door. Water drips and steam hisses from the locking mechanism, as you examine the small display - &quot;PLEASE SUPPLY PASSWORD&quot;. Below, a typewriter for you to input. You must study the mechanism hard - you might only have one shot...
</span></code></pre>
<p><a href="/htb-uni-quals-2021/bins/vault">vault</a></p>
<h1 id="reversing">reversing</h1>
<p>The first place to go is the main funtion! The binary is stripped but binary ninja is kinda enough to detect and rename it automatically, so all that is left is analyzing the function.</p>
<p><img src="/htb-uni-quals-2021/vault_main.png" alt="main function; reads a string from &quot;flag.txt&quot; and checks each char against another char derived from some gross vtable" /></p>
<p>It's fairly straightforward for a stripped c++ binary. At the top it opens up an ifstream for flag.txt and then it reads it byte by byte. Each byte is compared against the output of some gross function pointer return and if any of those comparisons are wrong it will print "Incorrect credentials".</p>
<p>All of the functions are just there in the binary if you wanted to reverse it manually but I do not. The thing is that every byte of the flag is in memory at some point so all you need to is feed it some placeholder flag and then extract each comparison byte.</p>
<h1 id="solve">solve</h1>
<p>I solved it using Qiling. I provided it a fake file and hooked the comparison instruction to log the register the byte of the flag was stored in -- ecx.</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">from </span><span>qiling </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">from </span><span>qiling</span><span style="color:#f29e74;">.</span><span>os</span><span style="color:#f29e74;">.</span><span>mapper </span><span style="color:#ffa759;">import </span><span>QlFsMappedObject
</span><span style="color:#ffa759;">class </span><span style="color:#73d0ff;">fake_flag</span><span>(</span><span style="text-decoration:underline;color:#73d0ff;">QlFsMappedObject</span><span>):
</span><span>    </span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">size</span><span>):
</span><span>        </span><span style="color:#ffa759;">return b</span><span style="color:#bae67e;">&quot;A&quot; </span><span style="color:#f29e74;">* </span><span style="color:#ffcc66;">20
</span><span>    </span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">fstat</span><span>(</span><span style="color:#ffcc66;">self</span><span>): </span><span style="font-style:italic;color:#5c6773;"># syscall fstat will ignore it if return -1
</span><span>        </span><span style="color:#ffa759;">return </span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">1
</span><span>    </span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">close</span><span>(</span><span style="color:#ffcc66;">self</span><span>):
</span><span>        </span><span style="color:#ffa759;">return </span><span style="color:#ffcc66;">0
</span><span>compared </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;&quot;
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">log_ecx</span><span>(</span><span style="color:#ffcc66;">ql</span><span>):
</span><span>    </span><span style="color:#ffa759;">global </span><span>compared
</span><span>    compared </span><span style="color:#f29e74;">+= </span><span style="color:#f28779;">chr</span><span>(ql</span><span style="color:#f29e74;">.</span><span>reg</span><span style="color:#f29e74;">.</span><span>ecx)
</span><span>ql </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">Qiling</span><span>([</span><span style="color:#bae67e;">&quot;./vault&quot;</span><span>]</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">rootfs</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&quot;/home/sky/tools/qiling/examples/rootfs/x8664_linux&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">console</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">False</span><span>)
</span><span>ql</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_fs_mapper</span><span>(</span><span style="color:#bae67e;">&#39;flag.txt&#39;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffd580;">fake_flag</span><span>())
</span><span>ql</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">hook_address</span><span>(log_ecx</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">0x555555554000 </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0xc3a1</span><span>) </span><span style="font-style:italic;color:#5c6773;"># rebase!
</span><span>ql</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">run</span><span>()
</span><span style="color:#f28779;">print</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;found flag = </span><span style="color:#95e6cb;">\&quot;</span><span>{compared}</span><span style="color:#95e6cb;">\&quot;</span><span style="color:#bae67e;">&quot;</span><span>)
</span></code></pre>
<pre data-lang="text" style="background-color:#212733;color:#ccc9c2;" class="language-text "><code class="language-text" data-lang="text"><span>‚ùØ python3 ./solve.py
</span><span>Incorrect Credentials - Anti Intruder Sequence Activated...
</span><span>found flag = &quot;HTB{vt4bl3s_4r3_c00l_huh}&quot;
</span></code></pre>

    </div>

    
    <div class="article-info">
        
        <div class="article-date">22 November 2021</div>
        
        <div class="article-taxonomies">
            
            
                <ul class="article-tags">
                    
                    <li><a href="https://tsheinen.github.io/tags/reversing/">#reversing</a></li>
                    
                    <li><a href="https://tsheinen.github.io/tags/qiling/">#qiling</a></li>
                    
                </ul>
            
        </div>
    </div>

</article>

<script>
window.onscroll = function() {
    if (window.innerHeight + window.pageYOffset >= document.body.offsetHeight) {
        var count = 200;
        var defaults = {
          origin: { y: 0.7 }
        };

        function fire(particleRatio, opts) {
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
          }));
        }

        fire(0.25, {
          spread: 26,
          startVelocity: 55,
        });
        fire(0.2, {
          spread: 60,
        });
        fire(0.35, {
          spread: 100,
          decay: 0.91,
          scalar: 0.8
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 25,
          decay: 0.92,
          scalar: 1.2
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 45,
        });
    }
}
</script>
<script type="text/javascript" src="/js/navbar.js"></script>


        </main>
        <footer>
            
            
        </footer>
    </div>



    <details data-popover="up" style="right: 20px;top: 20px;">
      <summary>
		  <svg class="paint-roller" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="paint-roller" class="svg-inline--fa fa-paint-roller fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M416 128V32c0-17.67-14.33-32-32-32H32C14.33 0 0 14.33 0 32v96c0 17.67 14.33 32 32 32h352c17.67 0 32-14.33 32-32zm32-64v128c0 17.67-14.33 32-32 32H256c-35.35 0-64 28.65-64 64v32c-17.67 0-32 14.33-32 32v128c0 17.67 14.33 32 32 32h64c17.67 0 32-14.33 32-32V352c0-17.67-14.33-32-32-32v-32h160c53.02 0 96-42.98 96-96v-64c0-35.35-28.65-64-64-64z"/></svg>
      </summary>
      <div class="swatch-container">
          
            <div class="swatch-child" onclick="setTheme('Dark')">
                <div style="text-align: center;">
                  <div data-theme=Dark class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Dark </span>
              </div>
            </div>
          
            <div class="swatch-child" onclick="setTheme('Light')">
                <div style="text-align: center;">
                  <div data-theme=Light class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Light </span>
              </div>
            </div>
          
      </div>
    </details>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "1e533cda4e344b0bb7c6bf7aef70a519"}'></script>
    <!-- End Cloudflare Web Analytics -->

    <script type="text/javascript" src="https://tsheinen.github.io/elasticlunr.min.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/search_index.en.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/js/search.js"></script>
</body>
</html>
